{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/log.ts"],"sourcesContent":["// lib/log.ts\n/**\n * Structured logging with Pino for production observability\n *\n * Replaces console.log with structured JSON logging for:\n * - Metrics aggregation (rate_limit.rejections, auth.redirects, etc.)\n * - Alerting (SLO violations)\n * - Debugging (correlated request tracing)\n */\n\nimport pino from \"pino\";\n\n// Configure Pino with production-safe settings\nconst inEdge = typeof (globalThis as { EdgeRuntime?: unknown }).EdgeRuntime !== \"undefined\";\nconst useTransport =\n  !inEdge &&\n  process.env.PINO_TRANSPORT !== \"none\" &&\n  process.env.NODE_ENV === \"production\"; // use worker only in prod\n\nexport const log = pino({\n  level: process.env.LOG_LEVEL ?? \"info\",\n  redact: {\n    paths: [\n      \"req.headers.authorization\",\n      \"req.headers.cookie\",\n      \"req.body.password\",\n      \"req.body.confirmPassword\",\n      \"password\",\n      \"token\"\n    ],\n    censor: \"[redacted]\"\n  },\n  // Add hostname and service name for multi-service correlation\n  base: {\n    service: \"senior-dog-rescue\",\n    hostname: process.env.HOSTNAME || \"unknown\",\n  },\n  // Pretty print in development for readability (but avoid worker transport)\n  ...(useTransport && {\n    transport: {\n      target: \"pino-pretty\",\n      options: {\n        colorize: true,\n        translateTime: \"SYS:standard\",\n        ignore: \"hostname,pid\",\n      },\n    },\n  }),\n});\n\n// Metric helpers for SLO tracking\nexport const metrics = {\n  // Rate limiting metrics\n  rateLimitRejection: (route: string, ipHash: string, userId?: string) =>\n    log.warn({\n      metric: \"rate_limit.rejections\",\n      route,\n      ipHash,\n      userId,\n      value: 1,\n    }, \"Rate limit exceeded\"),\n\n  // Authentication metrics\n  authRedirect: (route: string, reason: \"no_session\" | \"insufficient_role\", userRole?: string) =>\n    log.info({\n      metric: \"auth.redirects\",\n      route,\n      reason,\n      userRole,\n      value: 1,\n    }, \"Authentication redirect\"),\n\n  // Image security metrics\n  unknownImageHostRejection: (host: string, route: string) =>\n    log.warn({\n      metric: \"unknown_image_host_rejections\",\n      host,\n      route,\n      value: 1,\n    }, \"Unknown image host rejected\"),\n\n  // API latency metrics (p50/p95 tracking)\n  apiLatency: (route: string, method: string, statusCode: number, durationMs: number, userRole?: string) =>\n    log.info({\n      metric: \"api.latency_ms\",\n      route,\n      method,\n      statusCode,\n      durationMs,\n      userRole,\n      value: durationMs,\n    }, \"API request completed\"),\n\n  // Error metrics\n  serverError: (route: string, error: string, statusCode: number) =>\n    log.error({\n      metric: \"server.errors\",\n      route,\n      error,\n      statusCode,\n      value: 1,\n    }, \"Server error occurred\"),\n};\n\n// Helper to create child loggers with context\nexport function createRequestLogger(requestId: string, route: string) {\n  return log.child({\n    requestId,\n    route,\n  });\n}\n"],"names":[],"mappings":"AAAA,aAAa;AACb;;;;;;;CAOC;;;;;;;;AAED;;AAEA,+CAA+C;AAC/C,MAAM,SAAS,OAAO,AAAC,WAAyC,WAAW,KAAK;AAChF,MAAM,eACJ,CAAC,UACD,QAAQ,GAAG,CAAC,cAAc,KAAK,UAC/B,oDAAyB,cAAc,0BAA0B;AAE5D,MAAM,MAAM,IAAA,uIAAI,EAAC;IACtB,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAI;IAChC,QAAQ;QACN,OAAO;YACL;YACA;YACA;YACA;YACA;YACA;SACD;QACD,QAAQ;IACV;IACA,8DAA8D;IAC9D,MAAM;QACJ,SAAS;QACT,UAAU,QAAQ,GAAG,CAAC,QAAQ,IAAI;IACpC;IACA,2EAA2E;IAC3E,GAAI,gBAAgB;QAClB,WAAW;YACT,QAAQ;YACR,SAAS;gBACP,UAAU;gBACV,eAAe;gBACf,QAAQ;YACV;QACF;IACF,CAAC;AACH;AAGO,MAAM,UAAU;IACrB,wBAAwB;IACxB,oBAAoB,CAAC,OAAe,QAAgB,SAClD,IAAI,IAAI,CAAC;YACP,QAAQ;YACR;YACA;YACA;YACA,OAAO;QACT,GAAG;IAEL,yBAAyB;IACzB,cAAc,CAAC,OAAe,QAA4C,WACxE,IAAI,IAAI,CAAC;YACP,QAAQ;YACR;YACA;YACA;YACA,OAAO;QACT,GAAG;IAEL,yBAAyB;IACzB,2BAA2B,CAAC,MAAc,QACxC,IAAI,IAAI,CAAC;YACP,QAAQ;YACR;YACA;YACA,OAAO;QACT,GAAG;IAEL,yCAAyC;IACzC,YAAY,CAAC,OAAe,QAAgB,YAAoB,YAAoB,WAClF,IAAI,IAAI,CAAC;YACP,QAAQ;YACR;YACA;YACA;YACA;YACA;YACA,OAAO;QACT,GAAG;IAEL,gBAAgB;IAChB,aAAa,CAAC,OAAe,OAAe,aAC1C,IAAI,KAAK,CAAC;YACR,QAAQ;YACR;YACA;YACA;YACA,OAAO;QACT,GAAG;AACP;AAGO,SAAS,oBAAoB,SAAiB,EAAE,KAAa;IAClE,OAAO,IAAI,KAAK,CAAC;QACf;QACA;IACF;AACF","debugId":null}},
    {"offset": {"line": 228, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/rate-limiter.ts"],"sourcesContent":["// lib/rate-limiter.ts - Abstract rate limiting with Redis/Upstash support\nimport { Redis } from '@upstash/redis'\n\n// Rate limit configuration\nexport interface RateLimitConfig {\n  maxRequests: number;\n  windowMs: number;\n}\n\nexport interface RateLimitResult {\n  allowed: boolean;\n  resetTime?: number;\n  remaining?: number;\n}\n\n// Abstract rate limiter interface\nexport interface RateLimiter {\n  check(key: string, config: RateLimitConfig): Promise<RateLimitResult>;\n}\n\n// In-memory rate limiter for development and testing\nexport class MemoryRateLimiter implements RateLimiter {\n  private store = new Map<string, { count: number; resetTime: number }>();\n\n  async check(key: string, config: RateLimitConfig): Promise<RateLimitResult> {\n    const now = Date.now();\n    const current = this.store.get(key);\n\n    if (!current || now > current.resetTime) {\n      // First request or window expired\n      this.store.set(key, { count: 1, resetTime: now + config.windowMs });\n      return {\n        allowed: true,\n        resetTime: now + config.windowMs,\n        remaining: config.maxRequests - 1\n      };\n    }\n\n    if (current.count >= config.maxRequests) {\n      return {\n        allowed: false,\n        resetTime: current.resetTime,\n        remaining: 0\n      };\n    }\n\n    current.count++;\n    return {\n      allowed: true,\n      resetTime: current.resetTime,\n      remaining: config.maxRequests - current.count\n    };\n  }\n}\n\n// Redis-based rate limiter for production\nexport class RedisRateLimiter implements RateLimiter {\n  constructor(private redis: Redis) {}\n\n  async check(key: string, config: RateLimitConfig): Promise<RateLimitResult> {\n    const now = Date.now();\n    const windowStart = Math.floor(now / config.windowMs) * config.windowMs;\n    const windowKey = `${key}:${windowStart}`;\n\n    // Use Redis pipeline for atomic operations\n    const pipeline = this.redis.pipeline();\n    pipeline.incr(windowKey);\n    pipeline.expire(windowKey, Math.ceil(config.windowMs / 1000));\n\n    const results = await pipeline.exec();\n    const count = results[0] as number;\n\n    const allowed = count <= config.maxRequests;\n    const resetTime = windowStart + config.windowMs;\n\n    return {\n      allowed,\n      resetTime,\n      remaining: allowed ? config.maxRequests - count : 0\n    };\n  }\n}\n\n// Factory function to create appropriate rate limiter\nexport function createRateLimiter(): RateLimiter {\n  if (process.env.NODE_ENV === 'production') {\n    if (!process.env.UPSTASH_REDIS_REST_URL || !process.env.UPSTASH_REDIS_REST_TOKEN) {\n      console.warn('Redis environment variables not found, falling back to memory rate limiter');\n      return new MemoryRateLimiter();\n    }\n\n    const redis = new Redis({\n      url: process.env.UPSTASH_REDIS_REST_URL,\n      token: process.env.UPSTASH_REDIS_REST_TOKEN,\n    });\n\n    return new RedisRateLimiter(redis);\n  }\n\n  // Development and test environments use memory\n  return new MemoryRateLimiter();\n}\n\n// Global rate limiter instance\nexport const rateLimiter = createRateLimiter();\n"],"names":[],"mappings":"AAAA,0EAA0E;;;;;;;;;;;AAC1E;;AAoBO,MAAM;IACH,QAAQ,IAAI,MAAoD;IAExE,MAAM,MAAM,GAAW,EAAE,MAAuB,EAA4B;QAC1E,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,UAAU,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;QAE/B,IAAI,CAAC,WAAW,MAAM,QAAQ,SAAS,EAAE;YACvC,kCAAkC;YAClC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK;gBAAE,OAAO;gBAAG,WAAW,MAAM,OAAO,QAAQ;YAAC;YACjE,OAAO;gBACL,SAAS;gBACT,WAAW,MAAM,OAAO,QAAQ;gBAChC,WAAW,OAAO,WAAW,GAAG;YAClC;QACF;QAEA,IAAI,QAAQ,KAAK,IAAI,OAAO,WAAW,EAAE;YACvC,OAAO;gBACL,SAAS;gBACT,WAAW,QAAQ,SAAS;gBAC5B,WAAW;YACb;QACF;QAEA,QAAQ,KAAK;QACb,OAAO;YACL,SAAS;YACT,WAAW,QAAQ,SAAS;YAC5B,WAAW,OAAO,WAAW,GAAG,QAAQ,KAAK;QAC/C;IACF;AACF;AAGO,MAAM;;IACX,YAAY,AAAQ,KAAY,CAAE;aAAd,QAAA;IAAe;IAEnC,MAAM,MAAM,GAAW,EAAE,MAAuB,EAA4B;QAC1E,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,cAAc,KAAK,KAAK,CAAC,MAAM,OAAO,QAAQ,IAAI,OAAO,QAAQ;QACvE,MAAM,YAAY,GAAG,IAAI,CAAC,EAAE,aAAa;QAEzC,2CAA2C;QAC3C,MAAM,WAAW,IAAI,CAAC,KAAK,CAAC,QAAQ;QACpC,SAAS,IAAI,CAAC;QACd,SAAS,MAAM,CAAC,WAAW,KAAK,IAAI,CAAC,OAAO,QAAQ,GAAG;QAEvD,MAAM,UAAU,MAAM,SAAS,IAAI;QACnC,MAAM,QAAQ,OAAO,CAAC,EAAE;QAExB,MAAM,UAAU,SAAS,OAAO,WAAW;QAC3C,MAAM,YAAY,cAAc,OAAO,QAAQ;QAE/C,OAAO;YACL;YACA;YACA,WAAW,UAAU,OAAO,WAAW,GAAG,QAAQ;QACpD;IACF;AACF;AAGO,SAAS;IACd;;IAcA,+CAA+C;IAC/C,OAAO,IAAI;AACb;AAGO,MAAM,cAAc","debugId":null}},
    {"offset": {"line": 308, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/security-headers.ts"],"sourcesContent":["// lib/security-headers.ts - Centralized security headers configuration\nexport type SecurityHeaders = Record<string, string>;\n\n// Content Security Policy directives - mirrors allowed domains from next.config.ts\nfunction buildCSPDirectives(): string {\n  const baseImageDomains = [\n    'via.placeholder.com',\n    'picsum.photos',\n    'scontent.xx.fbcdn.net',\n    'external.xx.fbcdn.net',\n    'dl5zpyw5k3jeb.cloudfront.net',\n    'assets.adoptapet.com',\n    'muttville.org'\n  ];\n\n  // Add Supabase domain if available\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const connectSrcDomains: string[] = ['self'];\n  if (supabaseUrl) {\n    try {\n      const u = new URL(supabaseUrl);\n      baseImageDomains.push(u.hostname);\n      // Use the full origin to preserve scheme and port (e.g., http://localhost:54321)\n      connectSrcDomains.push(u.origin);\n    } catch {\n      // Invalid URL, skip\n    }\n  }\n\n  const imgSrc = `'self' data: blob: https://${baseImageDomains.join(' https://')}`;\n  // Allow Next.js HMR websocket and RSC requests in development\n  if (process.env.NODE_ENV === 'development') {\n    connectSrcDomains.push('ws://localhost:3000', 'ws://127.0.0.1:3000', 'http://localhost:3000');\n  }\n  const connectSrc = connectSrcDomains.join(' ');\n\n  // In development, allow unsafe-inline for scripts (needed for Next.js hot reload, Turbopack, etc.)\n  const isDev = process.env.NODE_ENV === 'development';\n  const scriptSrc = isDev ? \"'self' 'unsafe-inline'\" : \"'self'\";\n\n  return [\n    \"default-src 'self'\",\n    `script-src ${scriptSrc}`,\n    \"style-src 'self' 'unsafe-inline'\", // Next.js requires unsafe-inline for styles\n    `img-src ${imgSrc}`,\n    \"font-src 'self'\",\n    `connect-src ${connectSrc}`,\n    \"frame-src 'none'\",\n    \"object-src 'none'\",\n    \"base-uri 'self'\",\n    \"form-action 'self'\",\n    \"frame-ancestors 'none'\",\n  ].join('; ');\n}\n\nconst CSP_DIRECTIVES = buildCSPDirectives();\n\n/**\n * Returns the complete set of security headers for the application.\n * This is the single source of truth for all security headers.\n */\nexport function getSecurityHeaders(): SecurityHeaders {\n  return {\n    'Content-Security-Policy': CSP_DIRECTIVES,\n    'X-Content-Type-Options': 'nosniff',\n    'X-Frame-Options': 'DENY',\n    'X-XSS-Protection': '1; mode=block',\n    'Referrer-Policy': 'strict-origin-when-cross-origin',\n  };\n}\n\n/**\n * Applies security headers to a NextResponse object.\n * Mutates the response headers in place.\n */\nexport function applySecurityHeaders(response: Response): void {\n  const headers = getSecurityHeaders();\n  Object.entries(headers).forEach(([key, value]) => {\n    response.headers.set(key, value);\n  });\n}\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;;;AAGvE,mFAAmF;AACnF,SAAS;IACP,MAAM,mBAAmB;QACvB;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,mCAAmC;IACnC,MAAM;IACN,MAAM,oBAA8B;QAAC;KAAO;IAC5C,wCAAiB;QACf,IAAI;YACF,MAAM,IAAI,IAAI,IAAI;YAClB,iBAAiB,IAAI,CAAC,EAAE,QAAQ;YAChC,iFAAiF;YACjF,kBAAkB,IAAI,CAAC,EAAE,MAAM;QACjC,EAAE,OAAM;QACN,oBAAoB;QACtB;IACF;IAEA,MAAM,SAAS,CAAC,2BAA2B,EAAE,iBAAiB,IAAI,CAAC,cAAc;IACjF,8DAA8D;IAC9D,wCAA4C;QAC1C,kBAAkB,IAAI,CAAC,uBAAuB,uBAAuB;IACvE;IACA,MAAM,aAAa,kBAAkB,IAAI,CAAC;IAE1C,mGAAmG;IACnG,MAAM,QAAQ,oDAAyB;IACvC,MAAM,YAAY,uCAAQ,2BAA2B;IAErD,OAAO;QACL;QACA,CAAC,WAAW,EAAE,WAAW;QACzB;QACA,CAAC,QAAQ,EAAE,QAAQ;QACnB;QACA,CAAC,YAAY,EAAE,YAAY;QAC3B;QACA;QACA;QACA;QACA;KACD,CAAC,IAAI,CAAC;AACT;AAEA,MAAM,iBAAiB;AAMhB,SAAS;IACd,OAAO;QACL,2BAA2B;QAC3B,0BAA0B;QAC1B,mBAAmB;QACnB,oBAAoB;QACpB,mBAAmB;IACrB;AACF;AAMO,SAAS,qBAAqB,QAAkB;IACrD,MAAM,UAAU;IAChB,OAAO,OAAO,CAAC,SAAS,OAAO,CAAC,CAAC,CAAC,KAAK,MAAM;QAC3C,SAAS,OAAO,CAAC,GAAG,CAAC,KAAK;IAC5B;AACF","debugId":null}},
    {"offset": {"line": 384, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/middleware/security.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { getSecurityHeaders } from \"@/lib/security-headers\";\n\nfunction getResponseSecurityHeaders(): Record<string, string> {\n  return getSecurityHeaders() as unknown as Record<string, string>;\n}\n\nexport function applySecurityHeaders(response: NextResponse): NextResponse {\n  const headers = getResponseSecurityHeaders();\n  Object.entries(headers).forEach(([key, value]) => {\n    response.headers.set(key, value);\n  });\n  return response;\n}\n\n/**\n * Functional helper to apply security headers to a response\n * Returns the response with security headers applied\n */\nexport function withSecurityHeaders(response: NextResponse): NextResponse {\n  return applySecurityHeaders(response);\n}\n\nexport function createServiceUnavailableResponse(): NextResponse {\n  const response = new NextResponse(\"Service Unavailable\", {\n    status: 503,\n    headers: {\n      \"Content-Type\": \"text/plain\",\n    },\n  });\n  return applySecurityHeaders(response);\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEA,SAAS;IACP,OAAO,IAAA,gJAAkB;AAC3B;AAEO,SAAS,qBAAqB,QAAsB;IACzD,MAAM,UAAU;IAChB,OAAO,OAAO,CAAC,SAAS,OAAO,CAAC,CAAC,CAAC,KAAK,MAAM;QAC3C,SAAS,OAAO,CAAC,GAAG,CAAC,KAAK;IAC5B;IACA,OAAO;AACT;AAMO,SAAS,oBAAoB,QAAsB;IACxD,OAAO,qBAAqB;AAC9B;AAEO,SAAS;IACd,MAAM,WAAW,IAAI,8IAAY,CAAC,uBAAuB;QACvD,QAAQ;QACR,SAAS;YACP,gBAAgB;QAClB;IACF;IACA,OAAO,qBAAqB;AAC9B","debugId":null}},
    {"offset": {"line": 422, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/monitoring/sentry.ts"],"sourcesContent":["// lib/monitoring/sentry.ts\n/**\n * Sentry integration for error tracking and monitoring\n * \n * Gracefully degrades if Sentry is not configured (no env vars or package not installed)\n * In production, install @sentry/nextjs and set SENTRY_DSN to enable error tracking\n * \n * Usage:\n *   import { captureException, addBreadcrumb } from '@/lib/monitoring/sentry';\n *   await captureException(error, { userId, userRole, pathname });\n */\n\nlet sentryInitialized = false;\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nlet Sentry: any = null;\n\n// Type for Sentry event (when available)\ntype SentryEvent = {\n  message?: string;\n  [key: string]: unknown;\n};\n\n// Initialize Sentry if DSN is provided\nasync function initSentry() {\n  if (sentryInitialized) {\n    return;\n  }\n\n  sentryInitialized = true;\n\n  // Check if Sentry DSN is configured\n  if (!process.env.SENTRY_DSN) {\n    return; // Sentry not configured, skip initialization\n  }\n\n  try {\n    // Dynamic import to avoid breaking if package isn't installed\n    Sentry = await import('@sentry/nextjs');\n    Sentry.init({\n      dsn: process.env.SENTRY_DSN,\n      environment: process.env.NODE_ENV || 'development',\n      tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,\n      // Filter out sensitive data\n      beforeSend(event: SentryEvent) {\n        // Remove PII from error messages\n        if (event.message) {\n          event.message = event.message.replace(/email:[^\\s]+/gi, 'email:[REDACTED]');\n          event.message = event.message.replace(/phone:[^\\s]+/gi, 'phone:[REDACTED]');\n        }\n        return event;\n      },\n    });\n  } catch {\n    // Sentry package not installed or initialization failed - silently continue\n    if (process.env.NODE_ENV === 'development') {\n      console.warn('Sentry not available (package not installed or initialization failed)');\n    }\n  }\n}\n\n// Enhanced request tagging for SLO monitoring\nexport async function tagRequest(route: string, role?: string, rateLimited?: boolean) {\n  await initSentry();\n  if (!Sentry) return;\n\n  try {\n    Sentry.setTag(\"route\", route);\n    if (role) Sentry.setTag(\"role\", role);\n    Sentry.setTag(\"rate_limited\", String(!!rateLimited));\n  } catch {\n    // Silently fail if Sentry is unavailable\n  }\n}\n\n// Capture exception with context\nexport async function captureException(\n  error: Error,\n  context?: {\n    userId?: string | null;\n    userRole?: string | null;\n    pathname?: string;\n    route?: string;\n    rateLimited?: boolean;\n    tags?: Record<string, string>;\n  }\n) {\n  await initSentry();\n  if (!Sentry) return;\n\n  try {\n    Sentry.withScope((scope: {\n      setUser: (user: { id: string }) => void;\n      setTag: (key: string, value: string) => void;\n      [key: string]: unknown;\n    }) => {\n      if (context?.userId) {\n        scope.setUser({ id: context.userId });\n      }\n      if (context?.userRole) {\n        scope.setTag('role', context.userRole);\n      }\n      if (context?.pathname) {\n        scope.setTag('pathname', context.pathname);\n      }\n      if (context?.route) {\n        scope.setTag('route', context.route);\n      }\n      if (context?.rateLimited !== undefined) {\n        scope.setTag('rate_limited', String(context.rateLimited));\n      }\n      if (context?.tags) {\n        Object.entries(context.tags).forEach(([key, value]) => {\n          scope.setTag(key, value);\n        });\n      }\n      Sentry!.captureException(error);\n    });\n  } catch {\n    // Silently fail if Sentry is unavailable\n  }\n}\n\n// Add breadcrumb for middleware access denials\nexport async function addBreadcrumb(\n  message: string,\n  category: string,\n  data?: Record<string, unknown>\n) {\n  await initSentry();\n  if (!Sentry) return;\n\n  try {\n    Sentry.addBreadcrumb({\n      message,\n      category,\n      data,\n      level: 'warning',\n    });\n  } catch {\n    // Silently fail if Sentry is unavailable\n  }\n}\n\n// Capture message (non-exception)\nexport async function captureMessage(\n  message: string,\n  level: 'info' | 'warning' | 'error' = 'error',\n  context?: Record<string, unknown>\n) {\n  await initSentry();\n  if (!Sentry) return;\n\n  try {\n    Sentry.withScope((scope: {\n      setContext: (key: string, value: Record<string, unknown>) => void;\n      [key: string]: unknown;\n    }) => {\n      if (context) {\n        Object.entries(context).forEach(([key, value]) => {\n          scope.setContext(key, { value });\n        });\n      }\n      Sentry!.captureMessage(message, level);\n    });\n  } catch {\n    // Silently fail if Sentry is unavailable\n  }\n}\n\n"],"names":[],"mappings":"AAAA,2BAA2B;AAC3B;;;;;;;;;CASC;;;;;;;;;;AAED,IAAI,oBAAoB;AACxB,8DAA8D;AAC9D,IAAI,SAAc;AAQlB,uCAAuC;AACvC,eAAe;IACb,IAAI,mBAAmB;QACrB;IACF;IAEA,oBAAoB;IAEpB,oCAAoC;IACpC,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;QAC3B,QAAQ,6CAA6C;IACvD;IAEA,IAAI;QACF,8DAA8D;QAC9D,SAAS;QACT,OAAO,IAAI,CAAC;YACV,KAAK,QAAQ,GAAG,CAAC,UAAU;YAC3B,aAAa,mDAAwB;YACrC,kBAAkB,sCAAwC,0BAAM;YAChE,4BAA4B;YAC5B,YAAW,KAAkB;gBAC3B,iCAAiC;gBACjC,IAAI,MAAM,OAAO,EAAE;oBACjB,MAAM,OAAO,GAAG,MAAM,OAAO,CAAC,OAAO,CAAC,kBAAkB;oBACxD,MAAM,OAAO,GAAG,MAAM,OAAO,CAAC,OAAO,CAAC,kBAAkB;gBAC1D;gBACA,OAAO;YACT;QACF;IACF,EAAE,OAAM;QACN,4EAA4E;QAC5E,wCAA4C;YAC1C,QAAQ,IAAI,CAAC;QACf;IACF;AACF;AAGO,eAAe,WAAW,KAAa,EAAE,IAAa,EAAE,WAAqB;IAClF,MAAM;IACN,IAAI,CAAC,QAAQ;IAEb,IAAI;QACF,OAAO,MAAM,CAAC,SAAS;QACvB,IAAI,MAAM,OAAO,MAAM,CAAC,QAAQ;QAChC,OAAO,MAAM,CAAC,gBAAgB,OAAO,CAAC,CAAC;IACzC,EAAE,OAAM;IACN,yCAAyC;IAC3C;AACF;AAGO,eAAe,iBACpB,KAAY,EACZ,OAOC;IAED,MAAM;IACN,IAAI,CAAC,QAAQ;IAEb,IAAI;QACF,OAAO,SAAS,CAAC,CAAC;YAKhB,IAAI,SAAS,QAAQ;gBACnB,MAAM,OAAO,CAAC;oBAAE,IAAI,QAAQ,MAAM;gBAAC;YACrC;YACA,IAAI,SAAS,UAAU;gBACrB,MAAM,MAAM,CAAC,QAAQ,QAAQ,QAAQ;YACvC;YACA,IAAI,SAAS,UAAU;gBACrB,MAAM,MAAM,CAAC,YAAY,QAAQ,QAAQ;YAC3C;YACA,IAAI,SAAS,OAAO;gBAClB,MAAM,MAAM,CAAC,SAAS,QAAQ,KAAK;YACrC;YACA,IAAI,SAAS,gBAAgB,WAAW;gBACtC,MAAM,MAAM,CAAC,gBAAgB,OAAO,QAAQ,WAAW;YACzD;YACA,IAAI,SAAS,MAAM;gBACjB,OAAO,OAAO,CAAC,QAAQ,IAAI,EAAE,OAAO,CAAC,CAAC,CAAC,KAAK,MAAM;oBAChD,MAAM,MAAM,CAAC,KAAK;gBACpB;YACF;YACA,OAAQ,gBAAgB,CAAC;QAC3B;IACF,EAAE,OAAM;IACN,yCAAyC;IAC3C;AACF;AAGO,eAAe,cACpB,OAAe,EACf,QAAgB,EAChB,IAA8B;IAE9B,MAAM;IACN,IAAI,CAAC,QAAQ;IAEb,IAAI;QACF,OAAO,aAAa,CAAC;YACnB;YACA;YACA;YACA,OAAO;QACT;IACF,EAAE,OAAM;IACN,yCAAyC;IAC3C;AACF;AAGO,eAAe,eACpB,OAAe,EACf,QAAsC,OAAO,EAC7C,OAAiC;IAEjC,MAAM;IACN,IAAI,CAAC,QAAQ;IAEb,IAAI;QACF,OAAO,SAAS,CAAC,CAAC;YAIhB,IAAI,SAAS;gBACX,OAAO,OAAO,CAAC,SAAS,OAAO,CAAC,CAAC,CAAC,KAAK,MAAM;oBAC3C,MAAM,UAAU,CAAC,KAAK;wBAAE;oBAAM;gBAChC;YACF;YACA,OAAQ,cAAc,CAAC,SAAS;QAClC;IACF,EAAE,OAAM;IACN,yCAAyC;IAC3C;AACF","debugId":null}},
    {"offset": {"line": 559, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/middleware/rate-limit.ts"],"sourcesContent":["// lib/middleware/rate-limit.ts\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { rateLimiter } from \"@/lib/rate-limiter\";\nimport { applySecurityHeaders } from \"./security\";\nimport { metrics } from \"@/lib/log\";\nimport { tagRequest } from \"@/lib/monitoring/sentry\";\n// Edge-safe tiny hash (djb2)\nexport function tinyHash(input: string): string {\n  let h = 5381;\n  for (let i = 0; i < input.length; i++) h = ((h << 5) + h) ^ input.charCodeAt(i);\n  return (h >>> 0).toString(16);\n}\n\n// Rate limit configuration per user class\nexport const RATE_LIMITS = {\n  public: { maxRequests: 50, windowMs: 60 * 1000 }, // 50 requests per minute for public\n  auth: { maxRequests: 5, windowMs: 15 * 60 * 1000 }, // 5 requests per 15 minutes for auth\n  api: { maxRequests: 100, windowMs: 60 * 1000 }, // 100 requests per minute for API\n  staff: { maxRequests: 200, windowMs: 60 * 1000 }, // 200 requests per minute for staff\n  admin: { maxRequests: 500, windowMs: 60 * 1000 }, // 500 requests per minute for admin\n};\n\n// Get client IP from request\nexport function getClientIP(request: NextRequest): string {\n  const forwarded = request.headers.get('x-forwarded-for');\n  const realIP = request.headers.get('x-real-ip');\n  const clientIP = request.headers.get('x-client-ip');\n\n  if (forwarded) return forwarded.split(',')[0].trim();\n  if (realIP) return realIP;\n  if (clientIP) return clientIP;\n\n  return 'unknown';\n}\n\n// Check rate limit with optional user ID for authenticated users\nexport async function checkRateLimit(\n  ip: string,\n  endpoint: 'auth' | 'api' | 'public' | 'staff' | 'admin',\n  userId?: string | null\n): Promise<{ allowed: boolean; resetTime?: number; wouldBlock?: boolean }> {\n  // For authenticated users, key on user ID to prevent shared IP issues\n  // For unauthenticated users, key on IP\n  const key = userId ? `${endpoint}:user:${userId}` : `${endpoint}:ip:${ip}`;\n  const limit = RATE_LIMITS[endpoint];\n\n  const result = await rateLimiter.check(key, limit);\n  const shadowMode = isRateLimitShadowMode();\n\n  return {\n    allowed: shadowMode ? true : result.allowed, // Allow in shadow mode\n    resetTime: result.resetTime,\n    wouldBlock: !result.allowed // Track what would be blocked\n  };\n}\n\n// Create rate limit exceeded response with SLO tracking\nexport async function createRateLimitResponse(\n  resetTime: number,\n  clientIP: string,\n  pathname: string,\n  userId?: string | null\n): Promise<NextResponse> {\n  // Hash IP for privacy in logs (consistent hashing for rate limit analysis)\n  const ipHash = tinyHash(clientIP).slice(0, 16);\n\n  // Emit SLO metric for rate limit rejections\n  metrics.rateLimitRejection(pathname, ipHash, userId || undefined);\n\n  // Tag Sentry for alerting correlation\n  await tagRequest(pathname, undefined, true);\n\n  const resetDate = new Date(resetTime);\n  const response = new NextResponse('Too Many Requests', {\n    status: 429,\n    headers: {\n      'Content-Type': 'text/plain',\n      'Retry-After': Math.ceil((resetDate.getTime() - Date.now()) / 1000).toString(),\n      'X-RateLimit-Reset': resetDate.toISOString(),\n    },\n  });\n  return applySecurityHeaders(response);\n}\n\n// Check if rate limiting should be bypassed for tests\nexport function shouldBypassRateLimit(hasTestSecret: boolean): boolean {\n  return hasTestSecret && process.env.DISABLE_RATE_LIMITING_FOR_TESTS === 'true';\n}\n\n// Shadow mode: monitor what would be blocked without actually blocking\nexport function isRateLimitShadowMode(): boolean {\n  return process.env.RL_SHADOW_MODE === 'true';\n}\n"],"names":[],"mappings":"AAAA,+BAA+B;;;;;;;;;;;;;;;;;AAE/B;AACA;AACA;AACA;AACA;;;;;;AAEO,SAAS,SAAS,KAAa;IACpC,IAAI,IAAI;IACR,IAAK,IAAI,IAAI,GAAG,IAAI,MAAM,MAAM,EAAE,IAAK,IAAI,AAAC,CAAC,KAAK,CAAC,IAAI,IAAK,MAAM,UAAU,CAAC;IAC7E,OAAO,CAAC,MAAM,CAAC,EAAE,QAAQ,CAAC;AAC5B;AAGO,MAAM,cAAc;IACzB,QAAQ;QAAE,aAAa;QAAI,UAAU,KAAK;IAAK;IAC/C,MAAM;QAAE,aAAa;QAAG,UAAU,KAAK,KAAK;IAAK;IACjD,KAAK;QAAE,aAAa;QAAK,UAAU,KAAK;IAAK;IAC7C,OAAO;QAAE,aAAa;QAAK,UAAU,KAAK;IAAK;IAC/C,OAAO;QAAE,aAAa;QAAK,UAAU,KAAK;IAAK;AACjD;AAGO,SAAS,YAAY,OAAoB;IAC9C,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;IACtC,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;IACnC,MAAM,WAAW,QAAQ,OAAO,CAAC,GAAG,CAAC;IAErC,IAAI,WAAW,OAAO,UAAU,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI;IAClD,IAAI,QAAQ,OAAO;IACnB,IAAI,UAAU,OAAO;IAErB,OAAO;AACT;AAGO,eAAe,eACpB,EAAU,EACV,QAAuD,EACvD,MAAsB;IAEtB,sEAAsE;IACtE,uCAAuC;IACvC,MAAM,MAAM,SAAS,GAAG,SAAS,MAAM,EAAE,QAAQ,GAAG,GAAG,SAAS,IAAI,EAAE,IAAI;IAC1E,MAAM,QAAQ,WAAW,CAAC,SAAS;IAEnC,MAAM,SAAS,MAAM,qIAAW,CAAC,KAAK,CAAC,KAAK;IAC5C,MAAM,aAAa;IAEnB,OAAO;QACL,SAAS,aAAa,OAAO,OAAO,OAAO;QAC3C,WAAW,OAAO,SAAS;QAC3B,YAAY,CAAC,OAAO,OAAO,CAAC,8BAA8B;IAC5D;AACF;AAGO,eAAe,wBACpB,SAAiB,EACjB,QAAgB,EAChB,QAAgB,EAChB,MAAsB;IAEtB,2EAA2E;IAC3E,MAAM,SAAS,SAAS,UAAU,KAAK,CAAC,GAAG;IAE3C,4CAA4C;IAC5C,qHAAO,CAAC,kBAAkB,CAAC,UAAU,QAAQ,UAAU;IAEvD,sCAAsC;IACtC,MAAM,IAAA,yIAAU,EAAC,UAAU,WAAW;IAEtC,MAAM,YAAY,IAAI,KAAK;IAC3B,MAAM,WAAW,IAAI,8IAAY,CAAC,qBAAqB;QACrD,QAAQ;QACR,SAAS;YACP,gBAAgB;YAChB,eAAe,KAAK,IAAI,CAAC,CAAC,UAAU,OAAO,KAAK,KAAK,GAAG,EAAE,IAAI,MAAM,QAAQ;YAC5E,qBAAqB,UAAU,WAAW;QAC5C;IACF;IACA,OAAO,IAAA,qJAAoB,EAAC;AAC9B;AAGO,SAAS,sBAAsB,aAAsB;IAC1D,OAAO,iBAAiB,QAAQ,GAAG,CAAC,+BAA+B,KAAK;AAC1E;AAGO,SAAS;IACd,OAAO,QAAQ,GAAG,CAAC,cAAc,KAAK;AACxC","debugId":null}},
    {"offset": {"line": 663, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/middleware/context.ts"],"sourcesContent":["// lib/middleware/context.ts\n// Middleware context helper for request ID, logging, and common request data\n\nimport { NextRequest } from \"next/server\";\nimport { createRequestLogger } from \"@/lib/log\";\nimport { getClientIP } from \"./rate-limit\";\n\ninterface MiddlewareContext {\n  requestId: string;\n  clientIP: string;\n  pathname: string;\n  logger: ReturnType<typeof createRequestLogger>;\n}\n\n/**\n * Creates a middleware context with request ID, client IP, pathname, and logger\n * Centralizes the common setup logic used across middleware phases\n */\nexport function createMiddlewareContext(request: NextRequest): MiddlewareContext {\n  const requestId = globalThis.crypto?.randomUUID?.() ??\n    `${Date.now()}-${Math.random().toString(16).slice(2)}`;\n\n  const clientIP = getClientIP(request);\n  const pathname = request.nextUrl.pathname;\n  const logger = createRequestLogger(requestId, pathname);\n\n  return {\n    requestId,\n    clientIP,\n    pathname,\n    logger,\n  };\n}\n"],"names":[],"mappings":"AAAA,4BAA4B;AAC5B,6EAA6E;;;;;AAG7E;AACA;;;AAaO,SAAS,wBAAwB,OAAoB;IAC1D,MAAM,YAAY,WAAW,MAAM,EAAE,kBACnC,GAAG,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,KAAK,CAAC,IAAI;IAExD,MAAM,WAAW,IAAA,iJAAW,EAAC;IAC7B,MAAM,WAAW,QAAQ,OAAO,CAAC,QAAQ;IACzC,MAAM,SAAS,IAAA,iIAAmB,EAAC,WAAW;IAE9C,OAAO;QACL;QACA;QACA;QACA;IACF;AACF","debugId":null}},
    {"offset": {"line": 689, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/routes.ts"],"sourcesContent":["// lib/routes.ts - Single source of truth for route definitions and access control\n// This file consolidates route definitions from middleware.ts, lib/utils.ts, and e2e/access-matrix.ts\n// Import this file instead of defining routes in multiple places.\n\n/**\n * Route patterns organized by required role level.\n * Routes are patterns that support wildcards (e.g., \"/auth/*\").\n */\nexport const ROUTES = {\n  // Public routes - no authentication required\n  public: [\n    \"/\",\n    \"/adopt\",\n    \"/adopt/*\",\n    \"/happy-tails\",\n    \"/auth/*\",\n    \"/test/whoami\",\n    \"/favicon.ico\",\n    \"/opengraph-image.png\",\n    \"/twitter-image.png\",\n  ] as const,\n\n  // Volunteer routes - VOLUNTEER role or higher required\n  volunteer: [\n    \"/volunteer\",\n    \"/volunteer/my-shifts\",\n    \"/apply\",\n    \"/apply/*\",\n  ] as const,\n\n  // Staff routes - STAFF or ADMIN role required\n  staff: [\n    \"/admin\",\n    \"/admin/applications\",\n    \"/admin/dog\",\n    \"/admin/edit-dog\",\n    \"/admin/add-dog\",\n    \"/admin/fosters\",\n    \"/admin/shifts\",\n    \"/admin/events\",\n    \"/admin/dog/*?tab=medical\",\n    \"/staff/medical/*\",\n    \"/api/applications\",\n    \"/api/dogs\",\n    \"/api/events\",\n    \"/api/fosters\",\n    \"/api/shifts\",\n    \"/api/log\",\n    \"/api/medical-documents/*\",\n  ] as const,\n\n  // Admin routes - ADMIN role required\n  admin: [\n    \"/admin/users\",\n    \"/api/medical-documents\",\n    \"/api/admin/shifts/cancel\",\n  ] as const,\n} as const;\n\n/**\n * Check if path matches a pattern (supports wildcards).\n * Patterns ending with \"/*\" match the base path and all subpaths.\n */\nexport function matchesRoute(pathname: string, pattern: string): boolean {\n  if (pattern.endsWith(\"/*\")) {\n    const basePattern = pattern.slice(0, -2);\n    return pathname === basePattern || pathname.startsWith(basePattern + \"/\");\n  }\n  return pathname === pattern;\n}\n\n/**\n * Check if a pathname is a public route (no auth required).\n */\nexport function isPublicRoute(pathname: string): boolean {\n  return ROUTES.public.some(pattern => matchesRoute(pathname, pattern));\n}\n\n/**\n * Public paths allowlist for early exit checks.\n * This is a flattened list for efficient middleware checks.\n */\nexport const PUBLIC_PATHS = [\n  \"/\",\n  \"/adopt\",\n  \"/events\",\n  \"/happy-tails\",\n  \"/auth\",\n  \"/auth/login\",\n  \"/auth/sign-up\",\n  \"/auth/confirm\",\n  \"/auth/error\",\n  \"/auth/forgot-password\",\n  \"/auth/update-password\",\n  \"/auth/sign-up-success\",\n  \"/api/test-api\",\n  \"/api/test-api/*\",\n  \"/test/whoami\",\n  \"/favicon.ico\",\n  \"/opengraph-image.png\",\n  \"/twitter-image.png\",\n] as const;\n\n/**\n * Generate ACCESS_MATRIX format for E2E tests.\n * This converts the ROUTES structure into the format expected by tests.\n * Removes duplicates and ensures accurate route arrays.\n */\nexport function generateAccessMatrix() {\n  // Helper to deduplicate arrays\n  const dedupe = <T>(arr: T[]): T[] => Array.from(new Set(arr));\n\n  // Get all non-wildcard routes from each category\n  const publicRoutes = ROUTES.public.filter((r) => !r.includes(\"*\"));\n  const volunteerRoutes = ROUTES.volunteer.filter((r) => !r.includes(\"*\"));\n  const staffRoutes = ROUTES.staff.filter((r) => !r.includes(\"*\"));\n  const adminRoutes = ROUTES.admin.filter((r) => !r.includes(\"*\"));\n\n  return {\n    public: {\n      allowed: dedupe([\n        ...publicRoutes,\n        \"/auth/login\",\n        \"/auth/sign-up\",\n      ]),\n      denied: dedupe([\n        ...volunteerRoutes,\n        ...staffRoutes,\n        ...adminRoutes,\n        \"/volunteer\",\n        \"/volunteer/my-shifts\",\n        \"/admin\",\n        \"/admin/applications\",\n        \"/apply/adopt\",\n        \"/apply/foster\",\n        \"/protected\",\n      ]),\n    },\n    volunteer: {\n      allowed: dedupe([\n        ...publicRoutes,\n        ...volunteerRoutes,\n        \"/apply/adopt\",\n        \"/apply/foster\",\n      ]),\n      denied: dedupe([\n        ...staffRoutes.filter((r) => !r.startsWith(\"/api/\")),\n        ...adminRoutes.filter((r) => !r.startsWith(\"/api/\")),\n        \"/admin\",\n        \"/admin/applications\",\n        \"/admin/users\",\n      ]),\n    },\n    staff: {\n      allowed: dedupe([\n        ...publicRoutes,\n        ...volunteerRoutes,\n        ...staffRoutes,\n        \"/admin/users\",\n        \"/apply/adopt\",\n        \"/apply/foster\",\n      ]),\n      denied: [],\n    },\n    admin: {\n      allowed: dedupe([\n        ...publicRoutes,\n        ...volunteerRoutes,\n        ...staffRoutes,\n        ...adminRoutes,\n        \"/volunteer\",\n        \"/volunteer/my-shifts\",\n        \"/admin\",\n        \"/admin/applications\",\n        \"/admin/dog\",\n        \"/admin/edit-dog\",\n        \"/admin/add-dog\",\n        \"/admin/fosters\",\n        \"/admin/shifts\",\n        \"/admin/users\",\n        \"/apply/adopt\",\n        \"/apply/foster\",\n      ]),\n      denied: [],\n    },\n  } as const;\n}\n"],"names":[],"mappings":"AAAA,kFAAkF;AAClF,sGAAsG;AACtG,kEAAkE;AAElE;;;CAGC;;;;;;;;;;;;AACM,MAAM,SAAS;IACpB,6CAA6C;IAC7C,QAAQ;QACN;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,uDAAuD;IACvD,WAAW;QACT;QACA;QACA;QACA;KACD;IAED,8CAA8C;IAC9C,OAAO;QACL;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,qCAAqC;IACrC,OAAO;QACL;QACA;QACA;KACD;AACH;AAMO,SAAS,aAAa,QAAgB,EAAE,OAAe;IAC5D,IAAI,QAAQ,QAAQ,CAAC,OAAO;QAC1B,MAAM,cAAc,QAAQ,KAAK,CAAC,GAAG,CAAC;QACtC,OAAO,aAAa,eAAe,SAAS,UAAU,CAAC,cAAc;IACvE;IACA,OAAO,aAAa;AACtB;AAKO,SAAS,cAAc,QAAgB;IAC5C,OAAO,OAAO,MAAM,CAAC,IAAI,CAAC,CAAA,UAAW,aAAa,UAAU;AAC9D;AAMO,MAAM,eAAe;IAC1B;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAOM,SAAS;IACd,+BAA+B;IAC/B,MAAM,SAAS,CAAI,MAAkB,MAAM,IAAI,CAAC,IAAI,IAAI;IAExD,iDAAiD;IACjD,MAAM,eAAe,OAAO,MAAM,CAAC,MAAM,CAAC,CAAC,IAAM,CAAC,EAAE,QAAQ,CAAC;IAC7D,MAAM,kBAAkB,OAAO,SAAS,CAAC,MAAM,CAAC,CAAC,IAAM,CAAC,EAAE,QAAQ,CAAC;IACnE,MAAM,cAAc,OAAO,KAAK,CAAC,MAAM,CAAC,CAAC,IAAM,CAAC,EAAE,QAAQ,CAAC;IAC3D,MAAM,cAAc,OAAO,KAAK,CAAC,MAAM,CAAC,CAAC,IAAM,CAAC,EAAE,QAAQ,CAAC;IAE3D,OAAO;QACL,QAAQ;YACN,SAAS,OAAO;mBACX;gBACH;gBACA;aACD;YACD,QAAQ,OAAO;mBACV;mBACA;mBACA;gBACH;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;aACD;QACH;QACA,WAAW;YACT,SAAS,OAAO;mBACX;mBACA;gBACH;gBACA;aACD;YACD,QAAQ,OAAO;mBACV,YAAY,MAAM,CAAC,CAAC,IAAM,CAAC,EAAE,UAAU,CAAC;mBACxC,YAAY,MAAM,CAAC,CAAC,IAAM,CAAC,EAAE,UAAU,CAAC;gBAC3C;gBACA;gBACA;aACD;QACH;QACA,OAAO;YACL,SAAS,OAAO;mBACX;mBACA;mBACA;gBACH;gBACA;gBACA;aACD;YACD,QAAQ,EAAE;QACZ;QACA,OAAO;YACL,SAAS,OAAO;mBACX;mBACA;mBACA;mBACA;gBACH;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;aACD;YACD,QAAQ,EAAE;QACZ;IACF;AACF","debugId":null}},
    {"offset": {"line": 865, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/middleware/public-paths.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { matchesRoute, PUBLIC_PATHS } from \"@/lib/routes\";\nimport { applySecurityHeaders } from \"./security\";\n\nexport async function handlePublicPaths(\n  request: NextRequest,\n  pathname: string\n): Promise<NextResponse | null> {\n  // EARLY EXIT for public paths - allow without authentication\n  const isPublicPath = PUBLIC_PATHS.some(pattern => matchesRoute(pathname, pattern)) ||\n    pathname.startsWith('/_next/') ||\n    pathname.match(/\\.(svg|png|jpg|jpeg|gif|webp)$/);\n\n  if (isPublicPath) {\n    const response = NextResponse.next({ request });\n    return applySecurityHeaders(response);\n  }\n\n  return null;\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe,kBACpB,OAAoB,EACpB,QAAgB;IAEhB,6DAA6D;IAC7D,MAAM,eAAe,6HAAY,CAAC,IAAI,CAAC,CAAA,UAAW,IAAA,6HAAY,EAAC,UAAU,aACvE,SAAS,UAAU,CAAC,cACpB,SAAS,KAAK,CAAC;IAEjB,IAAI,cAAc;QAChB,MAAM,WAAW,8IAAY,CAAC,IAAI,CAAC;YAAE;QAAQ;QAC7C,OAAO,IAAA,qJAAoB,EAAC;IAC9B;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 890, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/middleware/rate-limiting.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport {\n  checkRateLimit,\n  createRateLimitResponse,\n  isRateLimitShadowMode,\n  tinyHash\n} from \"./rate-limit\";\nimport { metrics } from \"@/lib/log\";\n\nexport async function handleRateLimiting(\n  request: NextRequest,\n  clientIP: string,\n  pathname: string\n): Promise<NextResponse | null> {\n  // Rate limiting for auth endpoints (before authentication check)\n  if (pathname.startsWith('/auth/') || pathname.startsWith('/api/auth/')) {\n    const rateLimitResult = await checkRateLimit(clientIP, 'auth', null);\n    if (rateLimitResult.wouldBlock && isRateLimitShadowMode()) {\n      // Shadow mode: log but don't block\n      metrics.rateLimitRejection(pathname, tinyHash(clientIP).slice(0, 16));\n    } else if (!rateLimitResult.allowed) {\n      return await createRateLimitResponse(\n        rateLimitResult.resetTime || Date.now(),\n        clientIP,\n        pathname\n      );\n    }\n  }\n\n  // Note: API endpoint rate limiting is handled in handleAuthorization after session resolution\n\n  return null;\n}\n"],"names":[],"mappings":";;;;AACA;AAMA;;;AAEO,eAAe,mBACpB,OAAoB,EACpB,QAAgB,EAChB,QAAgB;IAEhB,iEAAiE;IACjE,IAAI,SAAS,UAAU,CAAC,aAAa,SAAS,UAAU,CAAC,eAAe;QACtE,MAAM,kBAAkB,MAAM,IAAA,oJAAc,EAAC,UAAU,QAAQ;QAC/D,IAAI,gBAAgB,UAAU,IAAI,IAAA,2JAAqB,KAAI;YACzD,mCAAmC;YACnC,qHAAO,CAAC,kBAAkB,CAAC,UAAU,IAAA,8IAAQ,EAAC,UAAU,KAAK,CAAC,GAAG;QACnE,OAAO,IAAI,CAAC,gBAAgB,OAAO,EAAE;YACnC,OAAO,MAAM,IAAA,6JAAuB,EAClC,gBAAgB,SAAS,IAAI,KAAK,GAAG,IACrC,UACA;QAEJ;IACF;IAEA,8FAA8F;IAE9F,OAAO;AACT","debugId":null}},
    {"offset": {"line": 922, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/utils/index.ts"],"sourcesContent":["// lib/utils/index.ts\n// Shared utility functions for the application\n\nimport { AppStatus, AppType } from \"@prisma/client\";\n\n/**\n * Humanize enum values by replacing underscores with spaces and capitalizing words\n */\nexport const humanizeEnum = (value: string): string => {\n  return value\n    .toLowerCase()\n    .replace(/_/g, ' ')\n    .replace(/\\b\\w/g, l => l.toUpperCase());\n};\n\n/**\n * Status variant functions for consistent badge styling\n */\nexport const getAppStatusVariant = (status: AppStatus) => {\n  switch (status) {\n    case \"APPROVED\": return \"default\";\n    case \"SUBMITTED\": case \"IN_REVIEW\": return \"secondary\";\n    case \"REJECTED\": return \"destructive\";\n    default: return \"outline\";\n  }\n};\n\n/**\n * Get allowed status transitions for applications\n */\nexport const getAllowedStatuses = (applicationType: AppType, currentStatus?: AppStatus): AppStatus[] => {\n  const allStatuses = Object.values(AppStatus);\n\n  // For foster applications, restrict some status transitions\n  if (applicationType === AppType.FOSTER) {\n    // Fosters can be approved (creates foster profile) or rejected\n    // Can't be marked as \"IN_REVIEW\" inappropriately\n    return allStatuses.filter(status =>\n      status !== AppStatus.IN_REVIEW || currentStatus === AppStatus.IN_REVIEW\n    );\n  }\n\n  // For adoption applications, all statuses are allowed\n  return allStatuses;\n};\n\n/**\n * Check if status change notes are required for a given status\n */\nexport const areStatusNotesRequired = (status: AppStatus): boolean => {\n  return status === AppStatus.APPROVED || status === AppStatus.REJECTED;\n};\n"],"names":[],"mappings":"AAAA,qBAAqB;AACrB,+CAA+C;;;;;;;;;;;AAE/C;;AAKO,MAAM,eAAe,CAAC;IAC3B,OAAO,MACJ,WAAW,GACX,OAAO,CAAC,MAAM,KACd,OAAO,CAAC,SAAS,CAAA,IAAK,EAAE,WAAW;AACxC;AAKO,MAAM,sBAAsB,CAAC;IAClC,OAAQ;QACN,KAAK;YAAY,OAAO;QACxB,KAAK;QAAa,KAAK;YAAa,OAAO;QAC3C,KAAK;YAAY,OAAO;QACxB;YAAS,OAAO;IAClB;AACF;AAKO,MAAM,qBAAqB,CAAC,iBAA0B;IAC3D,MAAM,cAAc,OAAO,MAAM,CAAC,0IAAS;IAE3C,4DAA4D;IAC5D,IAAI,oBAAoB,wIAAO,CAAC,MAAM,EAAE;QACtC,+DAA+D;QAC/D,iDAAiD;QACjD,OAAO,YAAY,MAAM,CAAC,CAAA,SACxB,WAAW,0IAAS,CAAC,SAAS,IAAI,kBAAkB,0IAAS,CAAC,SAAS;IAE3E;IAEA,sDAAsD;IACtD,OAAO;AACT;AAKO,MAAM,yBAAyB,CAAC;IACrC,OAAO,WAAW,0IAAS,CAAC,QAAQ,IAAI,WAAW,0IAAS,CAAC,QAAQ;AACvE","debugId":null}},
    {"offset": {"line": 970, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/utils.ts"],"sourcesContent":["import { clsx, type ClassValue } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nimport { AppStatus, AppType, DogStatus } from \"@prisma/client\";\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n\n\n// This check can be removed, it is just for tutorial purposes\nexport const hasEnvVars =\n  !!(process.env.NEXT_PUBLIC_SUPABASE_URL &&\n     process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY);\n\n\nexport const getDogStatusVariant = (status: DogStatus) => {\n  switch (status) {\n    case \"ADOPTED\": return \"default\";\n    case \"AVAILABLE\": return \"secondary\";\n    case \"MEDICAL_HOLD\": return \"destructive\";\n    case \"PENDING\": case \"IN_FOSTER\": return \"outline\";\n    default: return \"secondary\";\n  }\n};\n\n// Date formatting utilities\nexport const formatDateTime = (date: Date) =>\n  new Intl.DateTimeFormat(\"en-US\", {\n    month: \"short\",\n    day: \"numeric\",\n    year: \"numeric\",\n    hour: \"numeric\",\n    minute: \"2-digit\",\n  }).format(date);\n\nexport const formatDateRange = (start: Date, end: Date) => {\n  const sameDay =\n    start.getFullYear() === end.getFullYear() &&\n    start.getMonth() === end.getMonth() &&\n    start.getDate() === end.getDate();\n\n  if (sameDay) {\n    return `${formatDateTime(start)} – ${new Intl.DateTimeFormat(\"en-US\", {\n      hour: \"numeric\",\n      minute: \"2-digit\",\n    }).format(end)}`;\n  }\n\n  return `${formatDateTime(start)} → ${formatDateTime(end)}`;\n};\n\nexport const formatShiftTime = (start: Date, end: Date): string => {\n  const startDate = start.toLocaleDateString();\n  const startTime = start.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });\n  const endTime = end.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });\n\n  if (startDate === end.toLocaleDateString()) {\n    return `${startDate}, ${startTime} - ${endTime}`;\n  }\n  return `${startDate}, ${startTime} - ${end.toLocaleDateString()}, ${endTime}`;\n};\n\nexport const formatAdoptionDate = (date: Date) =>\n  new Intl.DateTimeFormat(\"en-US\", {\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n  }).format(date);\n\n// Re-export shared utilities\nexport { humanizeEnum, getAppStatusVariant, getAllowedStatuses, areStatusNotesRequired } from './utils/index';\n\n// Test endpoint validation - allow in test environment or with test secret header\nexport function validateTestEndpoint(request: Request): { isValid: boolean; response?: Response } {\n  const isTestEnv = process.env.NODE_ENV === 'test' && process.env.EXPOSE_TEST_API === '1';\n\n  const testSecret = request.headers.get('x-test-secret');\n  const expectedSecret = process.env.TEST_SECRET || 'test-secret-default';\n  const hasValidTestSecret = testSecret === expectedSecret;\n\n  if (!isTestEnv || !hasValidTestSecret) {\n    return {\n      isValid: false,\n      response: new Response(null, { status: 404 })\n    };\n  }\n\n  return { isValid: true };\n}\n\n// Route definitions have been moved to lib/routes.ts\n// Import route functions from @/lib/routes instead\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AACA;AAqEA,6BAA6B;AAC7B;;;AAlEO,SAAS,GAAG,GAAG,MAAoB;IACxC,OAAO,IAAA,sKAAO,EAAC,IAAA,6IAAI,EAAC;AACtB;AAIO,MAAM,aACX,CAAC,CAAC,CAAC,kKACyC;AAGvC,MAAM,sBAAsB,CAAC;IAClC,OAAQ;QACN,KAAK;YAAW,OAAO;QACvB,KAAK;YAAa,OAAO;QACzB,KAAK;YAAgB,OAAO;QAC5B,KAAK;QAAW,KAAK;YAAa,OAAO;QACzC;YAAS,OAAO;IAClB;AACF;AAGO,MAAM,iBAAiB,CAAC,OAC7B,IAAI,KAAK,cAAc,CAAC,SAAS;QAC/B,OAAO;QACP,KAAK;QACL,MAAM;QACN,MAAM;QACN,QAAQ;IACV,GAAG,MAAM,CAAC;AAEL,MAAM,kBAAkB,CAAC,OAAa;IAC3C,MAAM,UACJ,MAAM,WAAW,OAAO,IAAI,WAAW,MACvC,MAAM,QAAQ,OAAO,IAAI,QAAQ,MACjC,MAAM,OAAO,OAAO,IAAI,OAAO;IAEjC,IAAI,SAAS;QACX,OAAO,GAAG,eAAe,OAAO,GAAG,EAAE,IAAI,KAAK,cAAc,CAAC,SAAS;YACpE,MAAM;YACN,QAAQ;QACV,GAAG,MAAM,CAAC,MAAM;IAClB;IAEA,OAAO,GAAG,eAAe,OAAO,GAAG,EAAE,eAAe,MAAM;AAC5D;AAEO,MAAM,kBAAkB,CAAC,OAAa;IAC3C,MAAM,YAAY,MAAM,kBAAkB;IAC1C,MAAM,YAAY,MAAM,kBAAkB,CAAC,EAAE,EAAE;QAAE,MAAM;QAAW,QAAQ;IAAU;IACpF,MAAM,UAAU,IAAI,kBAAkB,CAAC,EAAE,EAAE;QAAE,MAAM;QAAW,QAAQ;IAAU;IAEhF,IAAI,cAAc,IAAI,kBAAkB,IAAI;QAC1C,OAAO,GAAG,UAAU,EAAE,EAAE,UAAU,GAAG,EAAE,SAAS;IAClD;IACA,OAAO,GAAG,UAAU,EAAE,EAAE,UAAU,GAAG,EAAE,IAAI,kBAAkB,GAAG,EAAE,EAAE,SAAS;AAC/E;AAEO,MAAM,qBAAqB,CAAC,OACjC,IAAI,KAAK,cAAc,CAAC,SAAS;QAC/B,MAAM;QACN,OAAO;QACP,KAAK;IACP,GAAG,MAAM,CAAC;;AAML,SAAS,qBAAqB,OAAgB;IACnD,MAAM,YAAY,oDAAyB,UAAU,QAAQ,GAAG,CAAC,eAAe,KAAK;IAErF,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,MAAM,iBAAiB,QAAQ,GAAG,CAAC,WAAW,IAAI;IAClD,MAAM,qBAAqB,eAAe;IAE1C,wCAAuC;QACrC,OAAO;YACL,SAAS;YACT,UAAU,IAAI,SAAS,MAAM;gBAAE,QAAQ;YAAI;QAC7C;IACF;;;AAGF,EAEA,qDAAqD;CACrD,mDAAmD","debugId":null}},
    {"offset": {"line": 1072, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/middleware/environment-check.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { hasEnvVars } from \"@/lib/utils\";\nimport { createServiceUnavailableResponse } from \"./security\";\n\ninterface Logger {\n  error(message: Record<string, unknown>, ...args: unknown[]): void;\n}\n\nexport async function handleEnvironmentCheck(\n  pathname: string,\n  logger: Logger\n): Promise<NextResponse | null> {\n  // FAIL-CLOSED: If required env vars are missing, block all access\n  // This prevents silent security failures - no redirects, just 503 Service Unavailable\n  if (!hasEnvVars) {\n    logger.error({\n      pathname,\n      nodeEnv: process.env.NODE_ENV,\n    }, 'Fail-closed triggered: missing required env vars');\n    return createServiceUnavailableResponse();\n  }\n\n  return null;\n}\n"],"names":[],"mappings":";;;;AACA;AACA;;;AAMO,eAAe,uBACpB,QAAgB,EAChB,MAAc;IAEd,kEAAkE;IAClE,sFAAsF;IACtF,IAAI,CAAC,0IAAU,EAAE;QACf,OAAO,KAAK,CAAC;YACX;YACA,OAAO;QACT,GAAG;QACH,OAAO,IAAA,iKAAgC;IACzC;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 1126, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/env.ts"],"sourcesContent":["import { z } from \"zod\";\n\n// Client-safe environment variables (can be imported by client code)\nconst ClientEnvSchema = z.object({\n  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),\n  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1).optional(),\n  NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: z.string().min(1).optional(),\n  NEXT_PUBLIC_SITE_URL: z.string().url(),\n});\n\n// Validate client-safe environment variables\nexport const clientEnv = ClientEnvSchema.parse({\n  NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,\n  NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\n  NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY,\n  NEXT_PUBLIC_SITE_URL: process.env.NEXT_PUBLIC_SITE_URL,\n});\n\n// Helper to get the Supabase anon key (supports both naming conventions)\nexport const getSupabaseAnonKey = () => clientEnv.NEXT_PUBLIC_SUPABASE_ANON_KEY || clientEnv.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!;\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,qEAAqE;AACrE,MAAM,kBAAkB,kLAAC,CAAC,MAAM,CAAC;IAC/B,0BAA0B,kLAAC,CAAC,MAAM,GAAG,GAAG;IACxC,+BAA+B,kLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,QAAQ;IACzD,sCAAsC,kLAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,QAAQ;IAChE,sBAAsB,kLAAC,CAAC,MAAM,GAAG,GAAG;AACtC;AAGO,MAAM,YAAY,gBAAgB,KAAK,CAAC;IAC7C,wBAAwB;IACxB,6BAA6B;IAC7B,oCAAoC;IACpC,oBAAoB;AACtB;AAGO,MAAM,qBAAqB,IAAM,UAAU,6BAA6B,IAAI,UAAU,oCAAoC","debugId":null}},
    {"offset": {"line": 1152, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/middleware/session.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { createServerClient } from \"@supabase/ssr\";\nimport { getSupabaseAnonKey } from \"@/lib/env\";\n\nexport async function getSession(request: NextRequest) {\n  let response = NextResponse.next({ request });\n\n  const supabase = createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    getSupabaseAnonKey(),\n    {\n      cookies: {\n        getAll() {\n          return request.cookies.getAll();\n        },\n        setAll(cookiesToSet) {\n          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value));\n          response = NextResponse.next({ request });\n          cookiesToSet.forEach(({ name, value, options }) => {\n            response.cookies.set(name, value, options);\n          });\n        },\n      },\n    },\n  );\n\n  const { data } = await supabase.auth.getClaims();\n  const userClaims = data?.claims ?? null;\n  const userId = userClaims?.sub ?? null;\n\n  return { response, userClaims, userId };\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AAAA;AACA;;;;AAEO,eAAe,WAAW,OAAoB;IACnD,IAAI,WAAW,8IAAY,CAAC,IAAI,CAAC;QAAE;IAAQ;IAE3C,MAAM,WAAW,IAAA,+LAAkB,gFAEjC,IAAA,gIAAkB,KAClB;QACE,SAAS;YACP;gBACE,OAAO,QAAQ,OAAO,CAAC,MAAM;YAC/B;YACA,QAAO,YAAY;gBACjB,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,GAAK,QAAQ,OAAO,CAAC,GAAG,CAAC,MAAM;gBACpE,WAAW,8IAAY,CAAC,IAAI,CAAC;oBAAE;gBAAQ;gBACvC,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;oBAC5C,SAAS,OAAO,CAAC,GAAG,CAAC,MAAM,OAAO;gBACpC;YACF;QACF;IACF;IAGF,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,SAAS;IAC9C,MAAM,aAAa,MAAM,UAAU;IACnC,MAAM,SAAS,YAAY,OAAO;IAElC,OAAO;QAAE;QAAU;QAAY;IAAO;AACxC","debugId":null}},
    {"offset": {"line": 1196, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/auth-redirect.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { applySecurityHeaders } from './middleware/security';\n\nexport function authRequiredRedirect(req: NextRequest, returnTo: string) {\n  const url = new URL('/auth/login', req.url);\n  url.searchParams.set('reason', 'authentication_required');\n  url.searchParams.set('returnTo', returnTo);\n  return applySecurityHeaders(NextResponse.redirect(url));\n}\n\nexport function insufficientPermissionsRedirect(req: NextRequest, returnTo: string) {\n  const url = new URL('/auth/login', req.url);\n  url.searchParams.set('reason', 'forbidden');\n  url.searchParams.set('returnTo', returnTo);\n  return applySecurityHeaders(NextResponse.redirect(url));\n}\n\n/**\n * Builds a login redirect URL string for use in Next.js server components.\n * Use this with Next.js `redirect()` function.\n * \n * @param reason - Either 'authentication_required' or 'insufficient_permissions'\n * @param returnTo - The path to redirect back to after login\n * @returns A relative URL string suitable for Next.js redirect()\n */\nexport function buildLoginRedirect(\n  reason: 'authentication_required' | 'insufficient_permissions',\n  returnTo: string\n): string {\n  const params = new URLSearchParams({\n    reason,\n    returnTo,\n  });\n  return `/auth/login?${params.toString()}`;\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAEO,SAAS,qBAAqB,GAAgB,EAAE,QAAgB;IACrE,MAAM,MAAM,IAAI,IAAI,eAAe,IAAI,GAAG;IAC1C,IAAI,YAAY,CAAC,GAAG,CAAC,UAAU;IAC/B,IAAI,YAAY,CAAC,GAAG,CAAC,YAAY;IACjC,OAAO,IAAA,qJAAoB,EAAC,8IAAY,CAAC,QAAQ,CAAC;AACpD;AAEO,SAAS,gCAAgC,GAAgB,EAAE,QAAgB;IAChF,MAAM,MAAM,IAAI,IAAI,eAAe,IAAI,GAAG;IAC1C,IAAI,YAAY,CAAC,GAAG,CAAC,UAAU;IAC/B,IAAI,YAAY,CAAC,GAAG,CAAC,YAAY;IACjC,OAAO,IAAA,qJAAoB,EAAC,8IAAY,CAAC,QAAQ,CAAC;AACpD;AAUO,SAAS,mBACd,MAA8D,EAC9D,QAAgB;IAEhB,MAAM,SAAS,IAAI,gBAAgB;QACjC;QACA;IACF;IACA,OAAO,CAAC,YAAY,EAAE,OAAO,QAAQ,IAAI;AAC3C","debugId":null}},
    {"offset": {"line": 1231, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/middleware/router.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\nimport { UserRole } from \"@prisma/client\";\nimport { authRequiredRedirect, insufficientPermissionsRedirect } from \"@/lib/auth-redirect\";\nimport { ROUTES, matchesRoute } from \"@/lib/routes\";\n\nexport function getRequiredRole(pathname: string): UserRole | null {\n  for (const pattern of ROUTES.admin) {\n    if (matchesRoute(pathname, pattern)) {\n      return UserRole.ADMIN;\n    }\n  }\n\n  for (const pattern of ROUTES.staff) {\n    if (matchesRoute(pathname, pattern)) {\n      return UserRole.STAFF;\n    }\n  }\n\n  for (const pattern of ROUTES.volunteer) {\n    if (matchesRoute(pathname, pattern)) {\n      return UserRole.VOLUNTEER;\n    }\n  }\n\n  for (const pattern of ROUTES.public) {\n    if (matchesRoute(pathname, pattern)) {\n      return null;\n    }\n  }\n\n  return UserRole.VOLUNTEER;\n}\n\nexport function hasSufficientRole(requiredRole: UserRole, userRole: UserRole): boolean {\n  const roleLevels = {\n    [UserRole.ADMIN]: 3,\n    [UserRole.STAFF]: 2,\n    [UserRole.VOLUNTEER]: 1,\n  };\n\n  const requiredLevel = roleLevels[requiredRole] ?? 0;\n  const userLevel = roleLevels[userRole] ?? 0;\n\n  return userLevel >= requiredLevel;\n}\n\nexport function checkAccess(\n  request: NextRequest,\n  pathname: string,\n  userRole: UserRole | undefined | null,\n) {\n  const requiredRole = getRequiredRole(pathname);\n\n  if (requiredRole === null) {\n    return null;\n  }\n\n  if (!userRole) {\n    return authRequiredRedirect(request, pathname);\n  }\n\n  if (!hasSufficientRole(requiredRole, userRole)) {\n    return insufficientPermissionsRedirect(request, pathname);\n  }\n\n  return null;\n}\n"],"names":[],"mappings":";;;;;;;;AACA;AACA;AACA;;;;AAEO,SAAS,gBAAgB,QAAgB;IAC9C,KAAK,MAAM,WAAW,uHAAM,CAAC,KAAK,CAAE;QAClC,IAAI,IAAA,6HAAY,EAAC,UAAU,UAAU;YACnC,OAAO,yIAAQ,CAAC,KAAK;QACvB;IACF;IAEA,KAAK,MAAM,WAAW,uHAAM,CAAC,KAAK,CAAE;QAClC,IAAI,IAAA,6HAAY,EAAC,UAAU,UAAU;YACnC,OAAO,yIAAQ,CAAC,KAAK;QACvB;IACF;IAEA,KAAK,MAAM,WAAW,uHAAM,CAAC,SAAS,CAAE;QACtC,IAAI,IAAA,6HAAY,EAAC,UAAU,UAAU;YACnC,OAAO,yIAAQ,CAAC,SAAS;QAC3B;IACF;IAEA,KAAK,MAAM,WAAW,uHAAM,CAAC,MAAM,CAAE;QACnC,IAAI,IAAA,6HAAY,EAAC,UAAU,UAAU;YACnC,OAAO;QACT;IACF;IAEA,OAAO,yIAAQ,CAAC,SAAS;AAC3B;AAEO,SAAS,kBAAkB,YAAsB,EAAE,QAAkB;IAC1E,MAAM,aAAa;QACjB,CAAC,yIAAQ,CAAC,KAAK,CAAC,EAAE;QAClB,CAAC,yIAAQ,CAAC,KAAK,CAAC,EAAE;QAClB,CAAC,yIAAQ,CAAC,SAAS,CAAC,EAAE;IACxB;IAEA,MAAM,gBAAgB,UAAU,CAAC,aAAa,IAAI;IAClD,MAAM,YAAY,UAAU,CAAC,SAAS,IAAI;IAE1C,OAAO,aAAa;AACtB;AAEO,SAAS,YACd,OAAoB,EACpB,QAAgB,EAChB,QAAqC;IAErC,MAAM,eAAe,gBAAgB;IAErC,IAAI,iBAAiB,MAAM;QACzB,OAAO;IACT;IAEA,IAAI,CAAC,UAAU;QACb,OAAO,IAAA,+IAAoB,EAAC,SAAS;IACvC;IAEA,IAAI,CAAC,kBAAkB,cAAc,WAAW;QAC9C,OAAO,IAAA,0JAA+B,EAAC,SAAS;IAClD;IAEA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 1295, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/middleware/authorization.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { UserRole } from \"@prisma/client\";\nimport { getSession } from \"./session\";\nimport { checkAccess, getRequiredRole } from \"./router\";\nimport { checkRateLimit, createRateLimitResponse, isRateLimitShadowMode, tinyHash } from \"./rate-limit\";\nimport { metrics } from \"@/lib/log\";\nimport { tagRequest } from \"@/lib/monitoring/sentry\";\nimport { applySecurityHeaders } from \"./security\";\n\ninterface Logger {\n  info(message: Record<string, unknown>, ...args: unknown[]): void;\n  warn(message: Record<string, unknown>, ...args: unknown[]): void;\n}\n\ninterface ExtendedRequest extends NextRequest {\n  _sessionResponse?: NextResponse;\n  _userRole?: UserRole | undefined;\n  _requiredRole?: UserRole | null;\n}\n\nexport async function handleAuthorization(\n  request: NextRequest,\n  pathname: string,\n  logger: Logger\n): Promise<NextResponse | null> {\n  const clientIP = request.headers.get('x-forwarded-for')?.split(',')[0].trim() ||\n                   request.headers.get('x-real-ip') ||\n                   request.headers.get('x-client-ip') ||\n                   'unknown';\n\n  const {\n    response: sessionResponse,\n    userClaims,\n    userId,\n  } = await getSession(request);\n  const userRole = (userClaims?.app_metadata?.role as UserRole | undefined) ?? undefined;\n\n  // Apply role-based rate limiting for API endpoints\n  if (pathname.startsWith('/api/') && !pathname.startsWith('/api/auth/')) {\n    let endpoint: 'public' | 'api' | 'staff' | 'admin' = 'public';\n    if (userRole === UserRole.ADMIN) {\n      endpoint = 'admin';\n    } else if (userRole === UserRole.STAFF) {\n      endpoint = 'staff';\n    } else if (userRole === UserRole.VOLUNTEER || userId) {\n      endpoint = 'api'; // Authenticated but not staff/admin\n    }\n\n    const rateLimitResult = await checkRateLimit(clientIP, endpoint, userId);\n    if (rateLimitResult.wouldBlock && isRateLimitShadowMode()) {\n      // Shadow mode: log but don't block\n      const ipHash = tinyHash(clientIP).slice(0, 16);\n      metrics.rateLimitRejection(pathname, ipHash, userId || undefined);\n    } else if (!rateLimitResult.allowed) {\n      return await createRateLimitResponse(\n        rateLimitResult.resetTime || Date.now(),\n        clientIP,\n        pathname,\n        userId\n      );\n    }\n  }\n\n  const requiredRole = getRequiredRole(pathname);\n\n  logger.info({\n    pathname,\n    requiredRole,\n    userRole,\n    userId,\n    hasClaims: !!userClaims,\n  }, 'Resolved user context');\n\n  const accessResponse = checkAccess(request, pathname, userRole);\n  if (accessResponse) {\n    const redirectLocation = accessResponse.headers.get('Location') ?? '';\n    const reason = redirectLocation.includes('reason=authentication_required')\n      ? \"no_session\"\n      : \"insufficient_role\";\n\n    metrics.authRedirect(pathname, reason, userRole || undefined);\n    await tagRequest(pathname, userRole || undefined);\n    logger.warn({\n      pathname,\n      requiredRole,\n      userId: userId || null,\n      userRole: userRole || null,\n    }, 'Access denied → redirecting to login');\n\n    return applySecurityHeaders(accessResponse);\n  }\n\n  // Store session data for finalizeResponse\n  const extendedRequest = request as ExtendedRequest;\n  extendedRequest._sessionResponse = sessionResponse;\n  extendedRequest._userRole = userRole;\n  extendedRequest._requiredRole = requiredRole;\n\n  return null;\n}\n"],"names":[],"mappings":";;;;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;AAaO,eAAe,oBACpB,OAAoB,EACpB,QAAgB,EAChB,MAAc;IAEd,MAAM,WAAW,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB,MAAM,IAAI,CAAC,EAAE,CAAC,UACtD,QAAQ,OAAO,CAAC,GAAG,CAAC,gBACpB,QAAQ,OAAO,CAAC,GAAG,CAAC,kBACpB;IAEjB,MAAM,EACJ,UAAU,eAAe,EACzB,UAAU,EACV,MAAM,EACP,GAAG,MAAM,IAAA,0IAAU,EAAC;IACrB,MAAM,WAAW,AAAC,YAAY,cAAc,QAAiC;IAE7E,mDAAmD;IACnD,IAAI,SAAS,UAAU,CAAC,YAAY,CAAC,SAAS,UAAU,CAAC,eAAe;QACtE,IAAI,WAAiD;QACrD,IAAI,aAAa,yIAAQ,CAAC,KAAK,EAAE;YAC/B,WAAW;QACb,OAAO,IAAI,aAAa,yIAAQ,CAAC,KAAK,EAAE;YACtC,WAAW;QACb,OAAO,IAAI,aAAa,yIAAQ,CAAC,SAAS,IAAI,QAAQ;YACpD,WAAW,OAAO,oCAAoC;QACxD;QAEA,MAAM,kBAAkB,MAAM,IAAA,oJAAc,EAAC,UAAU,UAAU;QACjE,IAAI,gBAAgB,UAAU,IAAI,IAAA,2JAAqB,KAAI;YACzD,mCAAmC;YACnC,MAAM,SAAS,IAAA,8IAAQ,EAAC,UAAU,KAAK,CAAC,GAAG;YAC3C,qHAAO,CAAC,kBAAkB,CAAC,UAAU,QAAQ,UAAU;QACzD,OAAO,IAAI,CAAC,gBAAgB,OAAO,EAAE;YACnC,OAAO,MAAM,IAAA,6JAAuB,EAClC,gBAAgB,SAAS,IAAI,KAAK,GAAG,IACrC,UACA,UACA;QAEJ;IACF;IAEA,MAAM,eAAe,IAAA,8IAAe,EAAC;IAErC,OAAO,IAAI,CAAC;QACV;QACA;QACA;QACA;QACA,WAAW,CAAC,CAAC;IACf,GAAG;IAEH,MAAM,iBAAiB,IAAA,0IAAW,EAAC,SAAS,UAAU;IACtD,IAAI,gBAAgB;QAClB,MAAM,mBAAmB,eAAe,OAAO,CAAC,GAAG,CAAC,eAAe;QACnE,MAAM,SAAS,iBAAiB,QAAQ,CAAC,oCACrC,eACA;QAEJ,qHAAO,CAAC,YAAY,CAAC,UAAU,QAAQ,YAAY;QACnD,MAAM,IAAA,yIAAU,EAAC,UAAU,YAAY;QACvC,OAAO,IAAI,CAAC;YACV;YACA;YACA,QAAQ,UAAU;YAClB,UAAU,YAAY;QACxB,GAAG;QAEH,OAAO,IAAA,qJAAoB,EAAC;IAC9B;IAEA,0CAA0C;IAC1C,MAAM,kBAAkB;IACxB,gBAAgB,gBAAgB,GAAG;IACnC,gBAAgB,SAAS,GAAG;IAC5B,gBAAgB,aAAa,GAAG;IAEhC,OAAO;AACT","debugId":null}},
    {"offset": {"line": 1369, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/middleware/finalize.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { UserRole } from \"@prisma/client\";\nimport { tagRequest } from \"@/lib/monitoring/sentry\";\nimport { applySecurityHeaders } from \"./security\";\n\ninterface Logger {\n  info(message: Record<string, unknown>, ...args: unknown[]): void;\n}\n\ninterface ExtendedRequest extends NextRequest {\n  _sessionResponse?: NextResponse;\n  _userRole?: UserRole | undefined;\n  _requiredRole?: UserRole | null;\n}\n\nexport async function finalizeResponse(\n  request: NextRequest,\n  pathname: string,\n  logger: Logger\n): Promise<NextResponse> {\n  const extendedRequest = request as ExtendedRequest;\n  const sessionResponse = extendedRequest._sessionResponse as NextResponse;\n  const userRole = extendedRequest._userRole;\n  const requiredRole = extendedRequest._requiredRole;\n\n  // API routes require additional scrutiny - don't broadly allow all /api/**\n  // Test endpoints are handled separately in their route handlers\n\n  // Add route markers for E2E testing - helps waiters identify page types\n  if (requiredRole) {\n    const routeId = pathname.split('/').filter(Boolean).join('-');\n    sessionResponse.headers.set('X-Route-Id', routeId);\n  }\n\n  // Apply security headers to the final response\n  applySecurityHeaders(sessionResponse);\n\n  // Track successful requests for SLO monitoring\n  await tagRequest(pathname, userRole);\n\n  logger.info({\n    pathname,\n    requiredRole,\n    userRole,\n  }, 'Allowing request to continue');\n\n  return sessionResponse;\n}\n"],"names":[],"mappings":";;;;AAEA;AACA;;;AAYO,eAAe,iBACpB,OAAoB,EACpB,QAAgB,EAChB,MAAc;IAEd,MAAM,kBAAkB;IACxB,MAAM,kBAAkB,gBAAgB,gBAAgB;IACxD,MAAM,WAAW,gBAAgB,SAAS;IAC1C,MAAM,eAAe,gBAAgB,aAAa;IAElD,2EAA2E;IAC3E,gEAAgE;IAEhE,wEAAwE;IACxE,IAAI,cAAc;QAChB,MAAM,UAAU,SAAS,KAAK,CAAC,KAAK,MAAM,CAAC,SAAS,IAAI,CAAC;QACzD,gBAAgB,OAAO,CAAC,GAAG,CAAC,cAAc;IAC5C;IAEA,+CAA+C;IAC/C,IAAA,qJAAoB,EAAC;IAErB,+CAA+C;IAC/C,MAAM,IAAA,yIAAU,EAAC,UAAU;IAE3B,OAAO,IAAI,CAAC;QACV;QACA;QACA;IACF,GAAG;IAEH,OAAO;AACT","debugId":null}},
    {"offset": {"line": 1404, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/middleware.ts"],"sourcesContent":["import { NextResponse, NextRequest } from \"next/server\";\n\n// Import helper functions\nimport { createMiddlewareContext } from \"@/lib/middleware/context\";\n\n// Import coordinators\nimport { handlePublicPaths } from \"./lib/middleware/public-paths\";\nimport { handleRateLimiting } from \"./lib/middleware/rate-limiting\";\nimport { handleEnvironmentCheck } from \"./lib/middleware/environment-check\";\nimport { handleAuthorization } from \"./lib/middleware/authorization\";\nimport { finalizeResponse } from \"./lib/middleware/finalize\";\n\n// Force Node.js runtime for middleware (not edge runtime)\n// This is needed because our environment validation doesn't work in edge runtime\nexport const runtime = 'nodejs';\n\nexport async function middleware(request: NextRequest): Promise<NextResponse> {\n  const ctx = createMiddlewareContext(request);\n\n  // Phase 1: Handle public paths (early exit)\n  const publicResponse = await handlePublicPaths(request, ctx.pathname);\n  if (publicResponse) return publicResponse;\n\n  // Phase 2: Rate limiting (before auth)\n  const rateLimitResponse = await handleRateLimiting(request, ctx.clientIP, ctx.pathname);\n  if (rateLimitResponse) return rateLimitResponse;\n\n  // Phase 3: Environment validation\n  const envResponse = await handleEnvironmentCheck(ctx.pathname, ctx.logger);\n  if (envResponse) return envResponse;\n\n  // Phase 4: Authorization & access control\n  const authResponse = await handleAuthorization(request, ctx.pathname, ctx.logger);\n  if (authResponse) return authResponse;\n\n  // Phase 5: Finalize successful request\n  return await finalizeResponse(request, ctx.pathname, ctx.logger);\n}\n\nexport const config = {\n  matcher: [\n    /*\n     * Match all request paths except:\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * - images - .svg, .png, .jpg, .jpeg, .gif, .webp\n     * Feel free to modify this pattern to include more paths.\n     */\n    \"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\n  ],\n};\n"],"names":[],"mappings":";;;;;;;;AAEA,0BAA0B;AAC1B;AAEA,sBAAsB;AACtB;AACA;AACA;AACA;AACA;;;;;;;AAIO,MAAM,UAAU;AAEhB,eAAe,WAAW,OAAoB;IACnD,MAAM,MAAM,IAAA,uJAAuB,EAAC;IAEpC,4CAA4C;IAC5C,MAAM,iBAAiB,MAAM,IAAA,yJAAiB,EAAC,SAAS,IAAI,QAAQ;IACpE,IAAI,gBAAgB,OAAO;IAE3B,uCAAuC;IACvC,MAAM,oBAAoB,MAAM,IAAA,2JAAkB,EAAC,SAAS,IAAI,QAAQ,EAAE,IAAI,QAAQ;IACtF,IAAI,mBAAmB,OAAO;IAE9B,kCAAkC;IAClC,MAAM,cAAc,MAAM,IAAA,mKAAsB,EAAC,IAAI,QAAQ,EAAE,IAAI,MAAM;IACzE,IAAI,aAAa,OAAO;IAExB,0CAA0C;IAC1C,MAAM,eAAe,MAAM,IAAA,yJAAmB,EAAC,SAAS,IAAI,QAAQ,EAAE,IAAI,MAAM;IAChF,IAAI,cAAc,OAAO;IAEzB,uCAAuC;IACvC,OAAO,MAAM,IAAA,iJAAgB,EAAC,SAAS,IAAI,QAAQ,EAAE,IAAI,MAAM;AACjE;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;;;;;;;KAOC,GACD;KACD;AACH","debugId":null}}]
}