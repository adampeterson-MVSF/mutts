{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/log.ts"],"sourcesContent":["// lib/log.ts\n/**\n * Structured logging with Pino for production observability\n *\n * Replaces console.log with structured JSON logging for:\n * - Metrics aggregation (rate_limit.rejections, auth.redirects, etc.)\n * - Alerting (SLO violations)\n * - Debugging (correlated request tracing)\n */\n\nimport pino from \"pino\";\n\n// Configure Pino with production-safe settings\nconst inEdge = typeof (globalThis as { EdgeRuntime?: unknown }).EdgeRuntime !== \"undefined\";\nconst useTransport =\n  !inEdge &&\n  process.env.PINO_TRANSPORT !== \"none\" &&\n  process.env.NODE_ENV === \"production\"; // use worker only in prod\n\nexport const log = pino({\n  level: process.env.LOG_LEVEL ?? \"info\",\n  redact: {\n    paths: [\n      \"req.headers.authorization\",\n      \"req.headers.cookie\",\n      \"req.body.password\",\n      \"req.body.confirmPassword\",\n      \"password\",\n      \"token\"\n    ],\n    censor: \"[redacted]\"\n  },\n  // Add hostname and service name for multi-service correlation\n  base: {\n    service: \"senior-dog-rescue\",\n    hostname: process.env.HOSTNAME || \"unknown\",\n  },\n  // Pretty print in development for readability (but avoid worker transport)\n  ...(useTransport && {\n    transport: {\n      target: \"pino-pretty\",\n      options: {\n        colorize: true,\n        translateTime: \"SYS:standard\",\n        ignore: \"hostname,pid\",\n      },\n    },\n  }),\n});\n\n// Metric helpers for SLO tracking\nexport const metrics = {\n  // Rate limiting metrics\n  rateLimitRejection: (route: string, ipHash: string, userId?: string) =>\n    log.warn({\n      metric: \"rate_limit.rejections\",\n      route,\n      ipHash,\n      userId,\n      value: 1,\n    }, \"Rate limit exceeded\"),\n\n  // Authentication metrics\n  authRedirect: (route: string, reason: \"no_session\" | \"insufficient_role\", userRole?: string) =>\n    log.info({\n      metric: \"auth.redirects\",\n      route,\n      reason,\n      userRole,\n      value: 1,\n    }, \"Authentication redirect\"),\n\n  // Image security metrics\n  unknownImageHostRejection: (host: string, route: string) =>\n    log.warn({\n      metric: \"unknown_image_host_rejections\",\n      host,\n      route,\n      value: 1,\n    }, \"Unknown image host rejected\"),\n\n  // API latency metrics (p50/p95 tracking)\n  apiLatency: (route: string, method: string, statusCode: number, durationMs: number, userRole?: string) =>\n    log.info({\n      metric: \"api.latency_ms\",\n      route,\n      method,\n      statusCode,\n      durationMs,\n      userRole,\n      value: durationMs,\n    }, \"API request completed\"),\n\n  // Error metrics\n  serverError: (route: string, error: string, statusCode: number) =>\n    log.error({\n      metric: \"server.errors\",\n      route,\n      error,\n      statusCode,\n      value: 1,\n    }, \"Server error occurred\"),\n};\n\n// Helper to create child loggers with context\nexport function createRequestLogger(requestId: string, route: string) {\n  return log.child({\n    requestId,\n    route,\n  });\n}\n"],"names":[],"mappings":"AAAA,aAAa;AACb;;;;;;;CAOC;;;;;;;;AAED;;AAEA,+CAA+C;AAC/C,MAAM,SAAS,OAAO,AAAC,WAAyC,WAAW,KAAK;AAChF,MAAM,eACJ,CAAC,UACD,QAAQ,GAAG,CAAC,cAAc,KAAK,UAC/B,oDAAyB,cAAc,0BAA0B;AAE5D,MAAM,MAAM,IAAA,uIAAI,EAAC;IACtB,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAI;IAChC,QAAQ;QACN,OAAO;YACL;YACA;YACA;YACA;YACA;YACA;SACD;QACD,QAAQ;IACV;IACA,8DAA8D;IAC9D,MAAM;QACJ,SAAS;QACT,UAAU,QAAQ,GAAG,CAAC,QAAQ,IAAI;IACpC;IACA,2EAA2E;IAC3E,GAAI,gBAAgB;QAClB,WAAW;YACT,QAAQ;YACR,SAAS;gBACP,UAAU;gBACV,eAAe;gBACf,QAAQ;YACV;QACF;IACF,CAAC;AACH;AAGO,MAAM,UAAU;IACrB,wBAAwB;IACxB,oBAAoB,CAAC,OAAe,QAAgB,SAClD,IAAI,IAAI,CAAC;YACP,QAAQ;YACR;YACA;YACA;YACA,OAAO;QACT,GAAG;IAEL,yBAAyB;IACzB,cAAc,CAAC,OAAe,QAA4C,WACxE,IAAI,IAAI,CAAC;YACP,QAAQ;YACR;YACA;YACA;YACA,OAAO;QACT,GAAG;IAEL,yBAAyB;IACzB,2BAA2B,CAAC,MAAc,QACxC,IAAI,IAAI,CAAC;YACP,QAAQ;YACR;YACA;YACA,OAAO;QACT,GAAG;IAEL,yCAAyC;IACzC,YAAY,CAAC,OAAe,QAAgB,YAAoB,YAAoB,WAClF,IAAI,IAAI,CAAC;YACP,QAAQ;YACR;YACA;YACA;YACA;YACA;YACA,OAAO;QACT,GAAG;IAEL,gBAAgB;IAChB,aAAa,CAAC,OAAe,OAAe,aAC1C,IAAI,KAAK,CAAC;YACR,QAAQ;YACR;YACA;YACA;YACA,OAAO;QACT,GAAG;AACP;AAGO,SAAS,oBAAoB,SAAiB,EAAE,KAAa;IAClE,OAAO,IAAI,KAAK,CAAC;QACf;QACA;IACF;AACF","debugId":null}},
    {"offset": {"line": 186, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/image-loader.ts"],"sourcesContent":["// lib/image-loader.ts\n// Custom Next.js Image loader with telemetry for domain validation\n\nimport { metrics } from \"@/lib/log\";\n\n// Allowed domains from next.config.ts for reference\nconst ALLOWED_DOMAINS = [\n  'via.placeholder.com',\n  'picsum.photos',\n  'scontent.xx.fbcdn.net',\n  'external.xx.fbcdn.net',\n  'dl5zpyw5k3jeb.cloudfront.net',\n  'assets.adoptapet.com',\n  'muttville.org',\n  // Supabase domain will be added dynamically below\n];\n\nexport default function imageLoader({ src, width, quality }: {\n  src: string;\n  width: number;\n  quality?: number;\n}) {\n  // Extract hostname from src URL for telemetry\n  try {\n    const url = new URL(src);\n    const hostname = url.hostname;\n\n    // Get Supabase hostname if available\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n    let supabaseHostname: string | null = null;\n    if (supabaseUrl) {\n      try {\n        supabaseHostname = new URL(supabaseUrl).hostname;\n      } catch {\n        // Invalid Supabase URL\n      }\n    }\n\n    const allAllowedDomains = supabaseHostname\n      ? [...ALLOWED_DOMAINS, supabaseHostname]\n      : ALLOWED_DOMAINS;\n\n    // Check if domain is in allowlist\n    const isAllowed = allAllowedDomains.some(allowed => {\n      if (allowed.includes('xx')) {\n        // Handle Facebook's region-specific domains\n        return hostname.includes('fbcdn.net');\n      }\n      return hostname === allowed || hostname === 'localhost'; // Allow localhost for development\n    });\n\n    if (!isAllowed) {\n      // Emit SLO metric for unknown image host rejections\n      metrics.unknownImageHostRejection(hostname, 'image-loader');\n\n      const errorMsg = `[ImageLoader] üö´ Domain not allowed: ${hostname}. Add to next.config.ts remotePatterns if legitimate.`;\n      console.error(errorMsg);\n      console.error(`[ImageLoader] Allowed domains: ${allAllowedDomains.join(', ')}`);\n      console.error(`[ImageLoader] Image source: ${src}`);\n\n      // In development, this will help catch configuration issues early\n      if (process.env.NODE_ENV === 'development') {\n        console.error(`[ImageLoader] To fix: Add '${hostname}' to remotePatterns in next.config.ts`);\n      }\n    } else {\n      // Log allowed domain usage for monitoring\n      console.log(`[ImageLoader] ‚úÖ Loading image from allowed domain: ${hostname}`);\n    }\n\n    // In development, warn about potentially problematic sources\n    if (process.env.NODE_ENV === 'development') {\n      const suspiciousPatterns = ['http:', 'localhost', '127.0.0.1', '0.0.0.0'];\n      const isSuspicious = suspiciousPatterns.some(pattern => src.includes(pattern));\n\n      if (isSuspicious) {\n        console.warn(`[ImageLoader] ‚ö†Ô∏è  Suspicious image source (allowed but review): ${src}`);\n      }\n    }\n  } catch (error) {\n    // If URL parsing fails, log the error for debugging\n    console.error(`[ImageLoader] Failed to parse image URL: ${src}`, error);\n  }\n\n  // Use Next.js default loader behavior\n  return `${src}?w=${width}&q=${quality || 75}`;\n}\n"],"names":[],"mappings":"AAAA,sBAAsB;AACtB,mEAAmE;;;;;AAEnE;;AAEA,oDAAoD;AACpD,MAAM,kBAAkB;IACtB;IACA;IACA;IACA;IACA;IACA;IACA;CAED;AAEc,SAAS,YAAY,EAAE,GAAG,EAAE,KAAK,EAAE,OAAO,EAIxD;IACC,8CAA8C;IAC9C,IAAI;QACF,MAAM,MAAM,IAAI,IAAI;QACpB,MAAM,WAAW,IAAI,QAAQ;QAE7B,qCAAqC;QACrC,MAAM;QACN,IAAI,mBAAkC;QACtC,wCAAiB;YACf,IAAI;gBACF,mBAAmB,IAAI,IAAI,aAAa,QAAQ;YAClD,EAAE,OAAM;YACN,uBAAuB;YACzB;QACF;QAEA,MAAM,oBAAoB,mBACtB;eAAI;YAAiB;SAAiB,GACtC;QAEJ,kCAAkC;QAClC,MAAM,YAAY,kBAAkB,IAAI,CAAC,CAAA;YACvC,IAAI,QAAQ,QAAQ,CAAC,OAAO;gBAC1B,4CAA4C;gBAC5C,OAAO,SAAS,QAAQ,CAAC;YAC3B;YACA,OAAO,aAAa,WAAW,aAAa,aAAa,kCAAkC;QAC7F;QAEA,IAAI,CAAC,WAAW;YACd,oDAAoD;YACpD,qHAAO,CAAC,yBAAyB,CAAC,UAAU;YAE5C,MAAM,WAAW,CAAC,qCAAqC,EAAE,SAAS,qDAAqD,CAAC;YACxH,QAAQ,KAAK,CAAC;YACd,QAAQ,KAAK,CAAC,CAAC,+BAA+B,EAAE,kBAAkB,IAAI,CAAC,OAAO;YAC9E,QAAQ,KAAK,CAAC,CAAC,4BAA4B,EAAE,KAAK;YAElD,kEAAkE;YAClE,wCAA4C;gBAC1C,QAAQ,KAAK,CAAC,CAAC,2BAA2B,EAAE,SAAS,qCAAqC,CAAC;YAC7F;QACF,OAAO;YACL,0CAA0C;YAC1C,QAAQ,GAAG,CAAC,CAAC,mDAAmD,EAAE,UAAU;QAC9E;QAEA,6DAA6D;QAC7D,wCAA4C;YAC1C,MAAM,qBAAqB;gBAAC;gBAAS;gBAAa;gBAAa;aAAU;YACzE,MAAM,eAAe,mBAAmB,IAAI,CAAC,CAAA,UAAW,IAAI,QAAQ,CAAC;YAErE,IAAI,cAAc;gBAChB,QAAQ,IAAI,CAAC,CAAC,gEAAgE,EAAE,KAAK;YACvF;QACF;IACF,EAAE,OAAO,OAAO;QACd,oDAAoD;QACpD,QAAQ,KAAK,CAAC,CAAC,yCAAyC,EAAE,KAAK,EAAE;IACnE;IAEA,sCAAsC;IACtC,OAAO,GAAG,IAAI,GAAG,EAAE,MAAM,GAAG,EAAE,WAAW,IAAI;AAC/C","debugId":null}}]
}