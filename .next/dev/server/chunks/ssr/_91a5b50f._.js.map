{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/lib/actions/profile.actions.ts"],"sourcesContent":["// lib/actions/profile.actions.ts\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { redirect } from \"next/navigation\";\nimport { prisma } from \"@/lib/prisma\";\nimport { UserRole } from \"@prisma/client\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport { z } from \"zod\";\nimport { ActionResult } from \"@/lib/types\";\n\nconst createProfileSchema = z.object({\n  name: z.string().optional(),\n});\n\n\n// Add this new function\nexport async function getActingUser(\n  { requireAuth = true }: { requireAuth?: boolean } = {}\n) {\n  // Check for synthetic session headers first (set by middleware)\n  const { headers } = await import('next/headers');\n  const headerData = await headers();\n  const testUserId = headerData.get('x-test-user-id');\n  const testUserRole = headerData.get('x-test-user-role');\n\n  if (testUserId && testUserRole) {\n    // Return a mock/partial User object based on headers\n    return {\n      id: testUserId,\n      email: `test-${testUserRole.toLowerCase()}@example.test`,\n      app_metadata: { role: testUserRole as UserRole },\n    } as {\n      id: string;\n      email: string;\n      app_metadata: { role: UserRole };\n    };\n  }\n\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n\n  if (requireAuth && !user) {\n    redirect(\"/auth/login\");\n  }\n  return user;\n}\n\n// Add this new function\nexport async function requireRole(role: UserRole | UserRole[]) {\n  const user = await getActingUser();\n  if (!user) {\n    // This should be redundant due to getActingUser, but good for type safety\n    throw new Error(\"Authentication required.\");\n  }\n\n  const roles = Array.isArray(role) ? role : [role];\n  const userRole = await getActingUserRole(); // Assumes this queries the DB\n\n  // Role hierarchy: ADMIN can access everything\n  if (userRole === UserRole.ADMIN) {\n    return; // Admin has access to everything\n  }\n\n  if (!roles.includes(userRole)) {\n    throw new Error(\"Unauthorized.\");\n  }\n}\n\n// Defense-in-depth RBAC helper - throws on unauthorized access\nexport async function assertRole(requiredRoles: UserRole | UserRole[]): Promise<void> {\n  const user = await getActingUser();\n  if (!user) {\n    throw new Error(\"Authentication required.\");\n  }\n\n  const userRole = await getActingUserRole();\n  const roles = Array.isArray(requiredRoles) ? requiredRoles : [requiredRoles];\n\n  // ADMIN can access everything\n  if (userRole === UserRole.ADMIN) {\n    return;\n  }\n\n  if (!roles.includes(userRole)) {\n    throw new Error(\"Insufficient permissions.\");\n  }\n}\n\nexport async function createProfile(name: string) {\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) { throw new Error(\"User not authenticated.\"); }\n\n  const parsed = createProfileSchema.safeParse({ name });\n  if (!parsed.success) {\n    throw new Error(parsed.error.issues[0]?.message ?? \"Invalid name\");\n  }\n\n  await prisma.profile.upsert({\n     where: { id: user.id },\n     update: { name: parsed.data.name, email: user.email }, // Update name/email if they exist\n     create: { id: user.id, email: user.email!, name: parsed.data.name },\n  });\n}\n\nexport async function updateUserRole(prevState: ActionResult, formData: FormData): Promise<ActionResult> {\n  try {\n    await assertRole(UserRole.ADMIN);\n\n    const userId = formData.get('userId') as string;\n    const role = formData.get('role') as UserRole;\n\n    if (!userId || !role) {\n      return {\n        success: false,\n        message: \"Missing required fields\",\n        fieldErrors: undefined,\n        data: null,\n      };\n    }\n\n    // Protect \"last admin\" from demotion\n    const adminCount = await prisma.profile.count({ where: { role: 'ADMIN' } });\n    const user = await prisma.profile.findUnique({ where: { id: userId }, select: { role: true } });\n    if (!user) {\n      return {\n        success: false,\n        message: 'User not found',\n        fieldErrors: { userId: ['User not found'] },\n        data: null,\n      };\n    }\n    if (user.role === 'ADMIN' && role !== 'ADMIN' && adminCount <= 1) {\n      return {\n        success: false,\n        message: 'Cannot demote the last admin',\n        fieldErrors: { role: ['Cannot demote the last admin'] },\n        data: null,\n      };\n    }\n\n    await prisma.profile.update({ where: { id: userId }, data: { role } });\n    revalidatePath('/admin/users');\n    return {\n      success: true,\n      message: 'Role updated successfully',\n      fieldErrors: undefined,\n      data: null,\n    };\n  } catch {\n    return {\n      success: false,\n      message: \"Failed to update user role\",\n      fieldErrors: undefined,\n      data: null,\n    };\n  }\n}\n\nexport async function getAllUsers() {\n  if (process.env.NODE_ENV !== 'test') {\n    await assertRole(UserRole.ADMIN);\n  }\n  return await prisma.profile.findMany({\n    orderBy: { email: \"asc\" },\n    select: {\n      id: true,\n      name: true,\n      email: true,\n      role: true,\n    },\n  });\n}\n\nexport async function getAllStaffUsers() {\n  if (process.env.NODE_ENV !== 'test') {\n    await assertRole(UserRole.STAFF);\n  }\n  return await prisma.profile.findMany({\n    where: {\n      role: {\n        in: [UserRole.STAFF, UserRole.ADMIN],\n      },\n    },\n    orderBy: { email: \"asc\" },\n    select: {\n      id: true,\n      name: true,\n      email: true,\n    },\n  });\n}\n\nexport async function getActingUserRole(): Promise<UserRole> {\n  // Check for synthetic session headers first (set by middleware)\n  const { headers } = await import('next/headers');\n  const headerData = await headers();\n  const testUserRole = headerData.get('x-test-user-role');\n\n  if (testUserRole && ['ADMIN', 'STAFF', 'VOLUNTEER'].includes(testUserRole)) {\n    return testUserRole as UserRole;\n  }\n\n  const supabase = await createClient();\n  const { data: { user } } = await supabase.auth.getUser();\n\n  if (!user) {\n    throw new Error(\"Not authenticated\");\n  }\n\n  const profile = await prisma.profile.findUnique({\n    where: { id: user.id },\n    select: { role: true },\n  });\n\n  if (!profile) {\n    throw new Error(\"Profile not found\");\n  }\n\n  return profile.role;\n}\n\nexport async function getUserProfile(userId: string) {\n  // Ensure user can only view their own profile (skip in test environment)\n  if (process.env.NODE_ENV !== 'test') {\n    const currentUser = await getActingUser();\n    if (!currentUser || currentUser.id !== userId) {\n      throw new Error(\"Unauthorized: Can only view your own profile\");\n    }\n  }\n\n  const parsed = z.object({ userId: z.string() }).safeParse({ userId });\n  if (!parsed.success) {\n    throw new Error(\"Invalid user ID\");\n  }\n\n  const profile = await prisma.profile.findUnique({\n    where: { id: userId },\n    select: {\n      name: true,\n      email: true,\n      role: true,\n      trainingCompleted: true,\n      backgroundCheckCompleted: true,\n      shiftCapacity: true,\n      prefersWeekdays: true,\n      prefersMornings: true,\n    },\n  });\n\n  // Return null if profile doesn't exist\n  return profile;\n}\n\nexport async function getUserSignupIds(userId: string) {\n  // Ensure user can only view their own signup IDs (skip in test environment)\n  if (process.env.NODE_ENV !== 'test') {\n    const currentUser = await getActingUser();\n    if (!currentUser || currentUser.id !== userId) {\n      throw new Error(\"Unauthorized: Can only view your own signups\");\n    }\n  }\n\n  const parsed = z.object({ userId: z.string() }).safeParse({ userId });\n  if (!parsed.success) {\n    throw new Error(\"Invalid user ID\");\n  }\n\n  try {\n    const userSignups = await prisma.volunteerShiftSignup.findMany({\n      where: { volunteerId: userId },\n      select: { shiftId: true }\n    });\n\n    return userSignups.map(signup => signup.shiftId);\n  } catch {\n    // Return empty array on any lookup failure (user doesn't exist, etc.)\n    return [];\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 368, "column": 0}, "map": {"version":3,"sources":["file:///Users/adampeterson/Github/mutts/.next-internal/server/app/admin/users/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getSSRUser as '000856392be4f7d53ed3e3e3326c2c888c8e2950e9'} from 'ACTIONS_MODULE0'\nexport {getAllStaffUsers as '0033a4aab8087bee60fa3957be6e412e7a28e6b142'} from 'ACTIONS_MODULE1'\nexport {getAllUsers as '0040745eebb8809dbc98afe0103726da3438000754'} from 'ACTIONS_MODULE1'\nexport {getActingUserRole as '006095df662d1f5454db62806f7d257b4264768061'} from 'ACTIONS_MODULE1'\nexport {getUserProfile as '40103a556ce1c8f26a74594d1623582c17a19007fe'} from 'ACTIONS_MODULE1'\nexport {requireRole as '401918a5b31d808cec1006f2b7ec1ed729ea95edbe'} from 'ACTIONS_MODULE1'\nexport {createProfile as '4029bb82f3e859aa7d1d5c000b17516a82e1704167'} from 'ACTIONS_MODULE1'\nexport {assertRole as '4058e90462fbf4a2c11008bad52cf288efe05a8b32'} from 'ACTIONS_MODULE1'\nexport {getActingUser as '40b6b27014bdc1a8fded8ff3d22be5fda4813317de'} from 'ACTIONS_MODULE1'\nexport {getUserSignupIds as '40c005c7807d025045aa1b80a1ad40fa0d179df6e8'} from 'ACTIONS_MODULE1'\nexport {updateUserRole as '60ceabe90fc8ed1b25017daee808de48043d157a6e'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AACA","debugId":null}}]
}